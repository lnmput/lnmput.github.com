<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"swoole.app","root":"/","images":"/images","scheme":"Gemini","version":"8.7.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="要么庸俗，要么孤独">
<meta property="og:type" content="website">
<meta property="og:title" content="外贸独立站(日本)">
<meta property="og:url" content="https://swoole.app/index.html">
<meta property="og:site_name" content="外贸独立站(日本)">
<meta property="og:description" content="要么庸俗，要么孤独">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="lnmput@gmail.com">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://swoole.app/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>外贸独立站(日本)</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">外贸独立站(日本)</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">专注外贸独立站建设</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-首页"><a href="/" rel="section">首页</a></li>
        <li class="menu-item menu-item-标签"><a href="/tags" rel="section">标签</a></li>
        <li class="menu-item menu-item-读书"><a href="/read" rel="section">读书</a></li>
        <li class="menu-item menu-item-翻译"><a href="/tags/translate" rel="section">翻译</a></li>
        <li class="menu-item menu-item-关于我"><a href="/about" rel="section">关于我</a></li>
        <li class="menu-item menu-item-外贸站"><a href="/site" rel="section">外贸站</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lnmput@gmail.com"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">lnmput@gmail.com</p>
  <div class="site-description" itemprop="description">要么庸俗，要么孤独</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">420</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">135</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://octobercms.com/" title="octobercms → https:&#x2F;&#x2F;octobercms.com&#x2F;" rel="noopener" target="_blank">octobercms</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://medium.com/" title="medium → https:&#x2F;&#x2F;medium.com&#x2F;" rel="noopener" target="_blank">medium</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/lnmput" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2024/07/26/combining-virtual-columns-with-indexes-in-laravel-eloquent/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2024/07/26/combining-virtual-columns-with-indexes-in-laravel-eloquent/" class="post-title-link" itemprop="url">combining_virtual_columns_with_indexes_in_laravel_eloquent</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-07-26 00:57:28 / 修改时间：01:07:22" itemprop="dateCreated datePublished" datetime="2024-07-26T00:57:28+09:00">2024-07-26</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
I'm still here. 
</blockquote>

<p>When it comes to building robust and efficient web applications, a well-structured database is crucial. Laravel simplifies database management with its elegant Object-Relational Mapping (ORM) tool called Eloquent. In this blog post, we’ll delve into an advanced database optimization technique: using indexes on virtual columns in MySQL, combined with Laravel Eloquent.</p>
<h3 id="Understanding-virtual-columns"><a href="#Understanding-virtual-columns" class="headerlink" title="Understanding virtual columns"></a>Understanding virtual columns</h3><p>Virtual columns, also known as generated columns, are columns in a database table that don’t physically store data but instead derive their values from other columns or expressions. These columns are computed on-the-fly when queried, providing a convenient way to manipulate and transform data without altering the actual table structure.</p>
<p>In MySQL, you can create virtual columns using expressions, such as mathematical calculations or string manipulations, and then index these columns for improved query performance.</p>
<h3 id="Benefits-of-virtual-column-indexing"><a href="#Benefits-of-virtual-column-indexing" class="headerlink" title="Benefits of virtual column indexing"></a>Benefits of virtual column indexing</h3><p>Indexing virtual columns can offer several advantages:</p>
<ul>
<li><p>Faster Query Performance: Indexes on virtual columns allow MySQL to quickly locate the relevant rows, reducing the time needed to retrieve data.</p>
</li>
<li><p>Simplified Data Transformation: Virtual columns enable you to perform complex data transformations within the database, reducing the need for application-level data manipulation.</p>
</li>
</ul>
<h3 id="Using-virtual-columns-in-laravel-eloquent"><a href="#Using-virtual-columns-in-laravel-eloquent" class="headerlink" title="Using virtual columns in laravel eloquent"></a>Using virtual columns in laravel eloquent</h3><p>Let’s walk through the steps to use virtual columns and indexes in Laravel Eloquent:</p>
<h4 id="Define-a-virtual-column-in-a-migration"><a href="#Define-a-virtual-column-in-a-migration" class="headerlink" title="Define a virtual column in a migration"></a>Define a virtual column in a migration</h4><p>To create a virtual column, you need to define it in a Laravel migration using the storedAs method. For example, let’s create a virtual column that calculates the total price based on the quantity and unit price:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Schema::create(<span class="string">&#x27;products&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint <span class="variable">$table</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span>-&gt;id();</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;decimal(<span class="string">&#x27;unit_price&#x27;</span>, <span class="number">8</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;integer(<span class="string">&#x27;quantity&#x27;</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;decimal(<span class="string">&#x27;total_price&#x27;</span>, <span class="number">8</span>, <span class="number">2</span>)</span><br><span class="line">            -&gt;storedAs(<span class="string">&#x27;unit_price * quantity&#x27;</span>) <span class="comment">// Define the virtual column</span></span><br><span class="line">            -&gt;index(); <span class="comment">// Index the virtual column</span></span><br><span class="line">        <span class="variable">$table</span>-&gt;timestamps();</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Use-the-virtual-column-in-eloquent-models"><a href="#Use-the-virtual-column-in-eloquent-models" class="headerlink" title="Use the virtual column in eloquent models"></a>Use the virtual column in eloquent models</h4><p>Once you’ve defined the virtual column, you can use it in your Eloquent models like any other column. Laravel Eloquent will handle the virtual column seamlessly:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$fillable</span> = [<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;unit_price&#x27;</span>, <span class="string">&#x27;quantity&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// You can access the virtual column as if it were a regular one</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$appends</span> = [<span class="string">&#x27;total_price&#x27;</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Now, you can access the total_price virtual column on your Product model instances as if it’s a standard attribute:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$product</span> = Product::find(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$product</span>-&gt;total_price; <span class="comment">// Access the virtual column</span></span><br></pre></td></tr></table></figure>

<h4 id="Benefit-from-indexing"><a href="#Benefit-from-indexing" class="headerlink" title="Benefit from indexing"></a>Benefit from indexing</h4><p>By adding the <code>-&gt;index()</code> method when defining the virtual column in your migration, you’ve instructed MySQL to create an index on it. This index will significantly improve query performance when filtering, sorting, or searching for records based on the virtual column.</p>
<h3 id="virtualAs-vs-storedAs"><a href="#virtualAs-vs-storedAs" class="headerlink" title="virtualAs vs storedAs"></a>virtualAs vs storedAs</h3><p>In Laravel Eloquent, both <code>storedAs</code> and <code>virtualAs</code> are methods used to work with virtual columns, but they serve slightly different purposes. Let’s explore the differences between these two methods.</p>
<p>The <code>storedAs</code> method is used to define a virtual column in a database table, and it specifies how the virtual column’s values are calculated and stored within the table. Here are the key characteristics of <code>storedAs</code>:</p>
<ul>
<li><p>Stored Value: When you use storedAs, the calculated value for the virtual column is physically stored in the database table. This means that the result of the expression or formula you provide in storedAs is computed when a record is inserted or updated, and the result is saved in the table.</p>
</li>
<li><p>Indexing: You can index virtual columns created with storedAs. Indexing can significantly improve query performance when filtering or searching based on the virtual column.</p>
</li>
<li><p>Data Integrity: Since the value is stored in the table, it’s subject to data integrity constraints. If the formula involves other columns, changes to those columns will trigger updates to the virtual column.</p>
</li>
</ul>
<p>Example:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$table</span>-&gt;decimal(<span class="string">&#x27;total_price&#x27;</span>, <span class="number">8</span>, <span class="number">2</span>)</span><br><span class="line">    -&gt;storedAs(<span class="string">&#x27;unit_price * quantity&#x27;</span>)</span><br><span class="line">    -&gt;index();</span><br></pre></td></tr></table></figure>

<p>In this example, the <code>total_price</code> column is a virtual column, and its value is calculated as the product of <code>unit_price</code> and quantity. The result is stored in the <code>total_price</code> column in the table, and an index is created on it.</p>
<p>On the other hand, the <code>virtualAs</code> method is used to define a virtual column without physically storing its values in the table. Here are the key characteristics of <code>virtualAs</code>:</p>
<ul>
<li><p>Computed On-the-Fly: When you use virtualAs, the virtual column’s value is computed on-the-fly whenever you query the database. It’s not physically stored in the table.</p>
</li>
<li><p>No Indexing: Since there’s no physical storage, you can’t create an index directly on a column defined with virtualAs. This can result in slower query performance when filtering or sorting by the virtual column.</p>
</li>
<li><p>bData Integrity: There are no data integrity constraints associated with virtualAs because no data is stored. Changes to other columns won’t affect the virtual column since it’s always calculated dynamically.</p>
</li>
</ul>
<p>Example:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$table</span>-&gt;virtualAs(<span class="string">&#x27;unit_price * quantity&#x27;</span>, <span class="string">&#x27;total_price&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>In this example, the <code>total_price</code> column is also a virtual column, but its value is calculated on-the-fly using the provided expression whenever you access it in a query. No physical storage or indexing is involved.</p>
<p>In summary, the choice between storedAs and <code>virtualAs</code> depends on your specific use case. If you need to frequently query and filter by the virtual column while maintaining data integrity, storedAs with indexing is a good option. If you only need the calculated value occasionally and don’t require data storage or indexing, <code>virtualAs</code> is more appropriate.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>Leveraging virtual columns with indexing in MySQL, coupled with Laravel Eloquent, can greatly enhance the efficiency and maintainability of your database-driven web applications. By offloading complex calculations to the database engine and optimizing queries with indexes, you’ll be well on your way to building high-performance applications that scale with ease.</p>
<p>So, next time you’re working on a Laravel project and need to perform calculations on your data, consider using virtual columns and indexing to boost your application’s database performance. Your users will thank you for the snappy response times, and your database will appreciate the reduced workload.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.yellowduck.be/posts/combining-virtual-columns-with-indexes-in-laravel-eloquent">https://www.yellowduck.be/posts/combining-virtual-columns-with-indexes-in-laravel-eloquent</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2023/09/15/How-to-automate-deployment-using-git-and-webhooks/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/09/15/How-to-automate-deployment-using-git-and-webhooks/" class="post-title-link" itemprop="url">How-to-automate-deployment-using-git-and-webhooks</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-09-15 00:30:19 / 修改时间：00:45:33" itemprop="dateCreated datePublished" datetime="2023-09-15T00:30:19+09:00">2023-09-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
I gave up， x
</blockquote>
Greetings humans (I am not a bot 😶) hope you are interfacing properly?

<p>Follow me on a journey as I show you a simple way of continuous deployment on a Laravel project using git and some other things (just read on).</p>
<p>For our tutorial, we’re going to need a few things before we proceed:</p>
<ul>
<li>A Laravel project</li>
<li>Some version of git (Github would be used for this tutorial, but the process is just about the same)</li>
<li>Access to a server (You can test locally tho but it won’t be the same)</li>
<li>Eyes</li>
<li>Fingers</li>
<li>A brain</li>
<li>ok I’ll stop now…<br>Let us start from the beginning, a laravel project</li>
</ul>
<p>Very beautiful framework, (no regrets about cheating on asp.net [this is not a confession 😶]).</p>
<p>The first thing we want to do on our project is use composer to install symfony/process to our project, we are going to need this package later.</p>
<p>You can do that by running this simple command at the root of your project</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">  composer require symfony/process</span></span><br></pre></td></tr></table></figure>
<p>This would load the required loadables to your composer.json file, in order to add the package to your project you just simply run this comman</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> composer update</span></span><br></pre></td></tr></table></figure>

<p>That should add the package to your vendors folder and generate the required classes and so on.</p>
<p>Here is a link to the Symfony docs where you can read up more about that.</p>
<p>After this is done, we are going to need a shell script that is going to hold the sauce to our magic.</p>
<p>This is how our shell script looks like:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> activate maintenance mode</span></span><br><span class="line">php artisan down</span><br><span class="line"><span class="meta">#</span><span class="bash"> update <span class="built_in">source</span> code</span></span><br><span class="line">git pull</span><br><span class="line"><span class="meta">#</span><span class="bash"> update PHP dependencies</span></span><br><span class="line">composer install --no-interaction --no-dev --prefer-dist</span><br><span class="line"><span class="meta">#</span><span class="bash"> --no-interaction Do not ask any interactive question</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --no-dev  Disables installation of require-dev packages.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --prefer-dist  Forces installation from package dist even <span class="keyword">for</span> dev versions.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> update database</span></span><br><span class="line">php artisan migrate --force</span><br><span class="line"><span class="meta">#</span><span class="bash"> --force  Required to run when <span class="keyword">in</span> production.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> stop maintenance mode</span></span><br><span class="line">php artisan up</span><br></pre></td></tr></table></figure>
<p>We can call this file deploy.sh</p>
<p>The truth is that this is just a template, you can modify this script to suit whatever needs you might have.</p>
<p>Now you have to make this script executable</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo chmod +x deploy.sh</span></span><br></pre></td></tr></table></figure>
<p>Depending on your production environment, this method is very risky so if you’re one of those “safety” freaks, just clap for me and move on…</p>
<p>But if you are one with the force (Linux) please proceed, it only get’s interesting from here.</p>
<p>Now we have our script ready, we would need to prepare for our git webhook.</p>
<p>On GitHub, on your repository page, select the Settings tab, then Webhooks in the left navigation. Or go directly to the URL:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/&lt;your account&gt;/&lt;your repository&gt;/settings/hooks</span><br></pre></td></tr></table></figure>

<p>Click Add Webook:</p>
<ul>
<li>Payload URL: <a target="_blank" rel="noopener" href="http://example.com/deploy">http://example.com/deploy</a></li>
<li>Secret: Some random long String (the longer the better 😏)</li>
</ul>
<p>Now we would need to add this webhook to our project (this is where it gets fun)</p>
<p>Firstly we need to add our secret to the project or in Layman’s terms we need make or project understand that there is a secret that a url needs before we proceed.</p>
<p>In config/app.php, add this line:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;deploy_secret&#x27; =&gt; env(&#x27;APP_DEPLOY_SECRET&#x27;),</span><br></pre></td></tr></table></figure>
<p>In your .env file add your webhook secret:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APP_DEPLOY_SECRET=changemenoworfacetheconsequences</span><br></pre></td></tr></table></figure>
<p>Now we’re done with the manual part, let’s write some codes</p>
<p>We need to make a controller which would house our logic and process for making our deploy process run. Now let’s make our controller…</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> php artisan make:controller DeployController</span></span><br></pre></td></tr></table></figure>

<p>I’m just going to call this controller DeployController for simplicity sake.</p>
<p>Then we would add all our code, don’t worry I’ll explain most of it. At the end our controller should look something like this:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Controllers</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Http</span>\<span class="title">Request</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Symfony</span>\<span class="title">Component</span>\<span class="title">Process</span>\<span class="title">Process</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DeployController</span> <span class="keyword">extends</span> <span class="title">Controller</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">deploy</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">     <span class="variable">$githubPayload</span> = <span class="variable">$request</span>-&gt;getContent();</span><br><span class="line">     <span class="variable">$githubHash</span> = <span class="variable">$request</span>-&gt;header(<span class="string">&#x27;X-Hub-Signature&#x27;</span>);</span><br><span class="line">     <span class="variable">$localToken</span> = config(<span class="string">&#x27;app.deploy_secret&#x27;</span>);</span><br><span class="line">     <span class="variable">$localHash</span> = <span class="string">&#x27;sha1=&#x27;</span> . hash_hmac(<span class="string">&#x27;sha1&#x27;</span>, <span class="variable">$githubPayload</span>, <span class="variable">$localToken</span>, <span class="literal">false</span>);</span><br><span class="line">     <span class="keyword">if</span> (hash_equals(<span class="variable">$githubHash</span>, <span class="variable">$localHash</span>)) &#123;</span><br><span class="line">          <span class="variable">$root_path</span> = base_path();</span><br><span class="line">          <span class="variable">$process</span> = <span class="keyword">new</span> Process(<span class="string">&#x27;cd &#x27;</span> . <span class="variable">$root_path</span> . <span class="string">&#x27;; ./deploy.sh&#x27;</span>);</span><br><span class="line">          <span class="variable">$process</span>-&gt;run(<span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$type</span>, <span class="variable">$buffer</span></span>) </span>&#123;</span><br><span class="line">              <span class="keyword">echo</span> <span class="variable">$buffer</span>;</span><br><span class="line">          &#125;);</span><br><span class="line">     &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Before I proceed, clap for me, it’s not easy to indent your code here on medium.com.<br>The code above does the following:</p>
<ul>
<li><p>Makes sure the post request it coming from GitHub using the X-Hub-Signature unique to github. You can remove this particular verification if you’re feeling adventurous but I recommend you keep it.<br>You can always refer to the git version control system documentation you are using for their own X-Signature</p>
</li>
<li><p>Makes sure the post request is coming from your github repo by verifying your deploy secret (in a production environment there are other checks before and after this, so don’t bother much about how flimsy the security might look)</p>
</li>
<li><p>Uses the symfony process to run the deploy script at the root of the project path in a shell environment</p>
</li>
</ul>
<p>That’s the basic gist about the code above, let’s proceed to adding a route to the webhook we added to github (or whatever proper sounding English that fits, English is hard)</p>
<p>Navigate to route/web.php in your project and add this line</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Route::post(<span class="string">&#x27;deploy&#x27;</span>, <span class="string">&#x27;DeployController@deploy&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>The method for this route has to always be a post method because github sends only post requests to webhooks, so you can call this another check if you want.</p>
<p>Secondly after this, to prevent CSRF token validation errors, we add the route above to our excepted route in the Middleware/VerifyCsrfToken.php</p>
<p>Which when done should look like this:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">App</span>\<span class="title">Http</span>\<span class="title">Middleware</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Illuminate</span>\<span class="title">Foundation</span>\<span class="title">Http</span>\<span class="title">Middleware</span>\<span class="title">VerifyCsrfToken</span> <span class="title">as</span> <span class="title">Middleware</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VerifyCsrfToken</span> <span class="keyword">extends</span> <span class="title">Middleware</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * The URIs that should be excluded from CSRF verification.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@var</span> array</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$except</span> = [</span><br><span class="line">        <span class="string">&#x27;/deploy&#x27;</span>,</span><br><span class="line">    ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>After this, on your server change the unix group of your project folder to www-data. This is necessary to allow the shell script to run in peace (allow the www-data user to update the project folder) this can be simply done by:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> sudo chgrp -R www-data .</span></span><br></pre></td></tr></table></figure>

<p>Then after all this, you are done.</p>
<p>With this now you have successfully set up a simple autodeployment (coughs Continuous Deployment) process on your project using git (while Jenkins and Travis are having some alone time).</p>
<p>If you’ve made it this far, Congratulations!!! You made it through series of bad jokes and hopefully learnt something, please a round of applause for yourself (I mean that clap button 😐)</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://medium.com/@gmaumoh/laravel-how-to-automate-deployment-using-git-and-webhooks-9ae6cd8dffae">https://medium.com/@gmaumoh/laravel-how-to-automate-deployment-using-git-and-webhooks-9ae6cd8dffae</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2023/03/02/OctoberCms-Relation-Lists-With-Filters/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/03/02/OctoberCms-Relation-Lists-With-Filters/" class="post-title-link" itemprop="url">OctoberCms-Relation-Lists-With-Filters</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-02 23:55:19" itemprop="dateCreated datePublished" datetime="2023-03-02T23:55:19+09:00">2023-03-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-03-03 11:00:18" itemprop="dateModified" datetime="2023-03-03T11:00:18+09:00">2023-03-03</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
不要太在意别人说的话，因为他们有嘴，但不一定有脑子
</blockquote>

<p>In more advanced projects you will soon realize that relation lists/forms and in general the whole RelationController is lacking funcionality. One of those things that are missing are filters in the relation list. But fear not, you can render lists and forms manually and then you can add filters to it. The best place to start with manual lists are these two tutorials: <a target="_blank" rel="noopener" href="https://octobercms.com/support/article/ob-21">https://octobercms.com/support/article/ob-21</a><br><a target="_blank" rel="noopener" href="https://octobercms.com/support/article/ob-20">https://octobercms.com/support/article/ob-20</a></p>
<p>But they only cover how to make a simple list rendered by hand in a partial and without filters. What I will cover in this article is how to do the same but using ListController (to render the list with filters for us automatically).</p>
<p>OctoberCMS - Relation lists with filters [HOWTO]<br>OctoberCMS | Date: Sep 23, 2018</p>
<p>In more advanced projects you will soon realize that relation lists/forms and in general the whole RelationController is lacking funcionality. One of those things that are missing are filters in the relation list. But fear not, you can render lists and forms manually and then you can add filters to it. The best place to start with manual lists are these two tutorials: <a target="_blank" rel="noopener" href="https://octobercms.com/support/article/ob-21">https://octobercms.com/support/article/ob-21</a><br><a target="_blank" rel="noopener" href="https://octobercms.com/support/article/ob-20">https://octobercms.com/support/article/ob-20</a></p>
<p>But they only cover how to make a simple list rendered by hand in a partial and without filters. What I will cover in this article is how to do the same but using ListController (to render the list with filters for us automatically).</p>
<p>Once you know the formula this is a pretty easy process. But I recon that getting there by yourself can be a painfull process (it was for me). After seeing the tutorial videos you would probably dive into the Behaviours and ListController to see how October does it because the documentation is still lacking. But it also has some good sides, you need to consciously code your plugins, you can’t just paste random code form internet and make a plugin out of it. In other words, your code quality will be by default higher than code for other leading CMS platforms :)</p>
<p>OctoberCMS - Relation lists with filters [HOWTO]<br>OctoberCMS | Date: Sep 23, 2018</p>
<p>In more advanced projects you will soon realize that relation lists/forms and in general the whole RelationController is lacking funcionality. One of those things that are missing are filters in the relation list. But fear not, you can render lists and forms manually and then you can add filters to it. The best place to start with manual lists are these two tutorials: <a target="_blank" rel="noopener" href="https://octobercms.com/support/article/ob-21">https://octobercms.com/support/article/ob-21</a><br><a target="_blank" rel="noopener" href="https://octobercms.com/support/article/ob-20">https://octobercms.com/support/article/ob-20</a></p>
<p>But they only cover how to make a simple list rendered by hand in a partial and without filters. What I will cover in this article is how to do the same but using ListController (to render the list with filters for us automatically).</p>
<p>Once you know the formula this is a pretty easy process. But I recon that getting there by yourself can be a painfull process (it was for me). After seeing the tutorial videos you would probably dive into the Behaviours and ListController to see how October does it because the documentation is still lacking. But it also has some good sides, you need to consciously code your plugins, you can’t just paste random code form internet and make a plugin out of it. In other words, your code quality will be by default higher than code for other leading CMS platforms :)</p>
<p>But let’s get to the point. Let’s say we have Order controller and model, then we have Product controller and model, both are glued together by Many to Many relationship with some pivot data. You will soon realize that when adding products to order manually (after reaching about 100 products) it gets really annoying to scroll through list of products to get those you want to add to order. Yeah you have search but sometimes you don’t remeber the name, or you just want to browse given product category or color or anything like that. List filter would come handy here. Below are the steps needed to take to achieve that:</p>
<ul>
<li>Add custom button to relation toolbar to have Ajax handler that will render the custom list. We will remove the default Add Product button(rendered by RelationController) and put a custom Add Product button.</li>
<li>We need custom Products list widget to display list of products</li>
<li>We need to attach filter to Products list widget</li>
<li>As an option we need to use a query scope to show, lets say only active products.</li>
</ul>
<p>STEP 1. Edit Controller/Orders/config_relation.yaml Your toolbarButtons declaration for products relation probably looks like that:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">toolbarButtons: add | remove</span><br></pre></td></tr></table></figure>

<p>Like I said before we want to use custom add button. Lets swap the default add button for a custom button. I will call it “productsadd” The line will look like this:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">toolbarButtons: productsadd | remove</span><br></pre></td></tr></table></figure>
<p>Now we need to put the code for the custom button somewhere, October is really making this easy for us. The only thing we need to do is to create a file called <code>_relation_button_productsadd.htm</code> in Controller/orders directory.<br>This is how my file looks like:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;button</span><br><span class="line"><span class="class"><span class="keyword">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">secondary</span> <span class="title">oc</span>-<span class="title">icon</span>-<span class="title">plus</span>&quot;</span></span><br><span class="line"><span class="class"><span class="title">data</span>-<span class="title">control</span>=&quot;<span class="title">popup</span>&quot;</span></span><br><span class="line"><span class="class"><span class="title">data</span>-<span class="title">handler</span>=&quot;<span class="title">onAddProduct</span>&quot;</span></span><br><span class="line"><span class="class"><span class="title">data</span>-<span class="title">size</span>=&quot;<span class="title">large</span>&quot;&gt;</span></span><br><span class="line"><span class="class"><span class="title">Add</span> <span class="title">Product</span></span></span><br></pre></td></tr></table></figure>
<p>Two most important lines here are:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data-control=<span class="string">&quot;popup&quot;</span></span><br></pre></td></tr></table></figure>
<p>This will open the relation list in the modal window.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">data-handler=<span class="string">&quot;onAddProduct&quot;</span></span><br></pre></td></tr></table></figure>
<p>This is our Ajax Handler to display custom list. We need to add a function in our Orders controller to handle it. Lets go to Controllers/Orders.php, but before we will add this action we should do some other things too. I will put it all in one file with comments explaning the lines of code we will add. Bear in mind that this is not the complete Orders.php controller file. Those are mostly only the lines of code you need to add.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[...]</span><br><span class="line"><span class="comment"># List and Filter widgets variables, name them as you want :)</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$productsListWidget</span>;</span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$productsFilterWidget</span>;</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="built_in">parent</span>::construct();</span><br><span class="line">BackendMenu::setContext(<span class="string">&#x27;Redmarlin.ShopClerk&#x27;</span>, <span class="string">&#x27;Shop&#x27;</span>, <span class="string">&#x27;Orders&#x27;</span>);</span><br><span class="line">    <span class="comment">#We need to create Products List Widget</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;productsListWidget = <span class="keyword">$this</span>-&gt;createProductListWidget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"><span class="comment"># This is Ajax Handler invoked when clickin on &quot;Add Product&quot; button. What it does is to just assign</span></span><br><span class="line"><span class="comment"># previously created widgets to variables that are accessible from partials.</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">onAddProduct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;vars[<span class="string">&#x27;ProductListWidget&#x27;</span>] = <span class="keyword">$this</span>-&gt;ProductListWidget;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Variable necessary for the Filter funcionality</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;vars[<span class="string">&#x27;ProductFilterWidget&#x27;</span>] = <span class="keyword">$this</span>-&gt;ProductFilterWidget;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Process the custom list partial, The name you choose here will be the partials file name</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;makePartial(<span class="string">&#x27;product_custom_list&#x27;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Ahhh finally there, the most important part, here we declare all the necessary</span></span><br><span class="line"><span class="comment"># things to make List widget with filters happen.</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">createProductListWidget</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#First we need config for the list, as described in video tutorials mentioned at the beginning.</span></span><br><span class="line">    <span class="comment"># Specify which list configuration file use for this list</span></span><br><span class="line">    <span class="variable">$config</span> = <span class="keyword">$this</span>-&gt;makeConfig(<span class="string">&#x27;$/redmarlin/shopclerk/models/product/columns_relation.yaml&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Specify the List model</span></span><br><span class="line">    <span class="variable">$config</span>-&gt;model = <span class="keyword">New</span> \Redmarlin\ShopClerk\Models\Product ;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Lets configure some more things like report per page and lets show checkboxes on the list.</span></span><br><span class="line">    <span class="comment"># Most of the options mentioned in https://octobercms.com/docs/backend/lists#configuring-list # will work</span></span><br><span class="line">    <span class="variable">$config</span>-&gt;recordsPerPage = <span class="string">&#x27;30&#x27;</span>;</span><br><span class="line">    <span class="variable">$config</span>-&gt;showCheckboxes = <span class="string">&#x27;true&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Here we will actually make the list using Lists Widget</span></span><br><span class="line">    <span class="variable">$widget_product</span> = <span class="keyword">$this</span>-&gt;makeWidget(<span class="string">&#x27;Backend\Widgets\Lists&#x27;</span>, <span class="variable">$config</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">#For the optional Step 4. Alter product list query before displaying it.</span></span><br><span class="line">    <span class="comment"># We will bind to list.extendQuery event and assign a function that should be executed to extend</span></span><br><span class="line">    <span class="comment"># the query (the function is defined in this very same controller file)</span></span><br><span class="line">    <span class="variable">$widget_product</span>-&gt;bindEvent(<span class="string">&#x27;list.extendQuery&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$query</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;productExtendQuery(<span class="variable">$query</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Step 3. The filter part, we must define the config, really similar to the Product list widget config</span></span><br><span class="line">    <span class="comment"># Filter configuration file</span></span><br><span class="line">    <span class="variable">$filterConfig</span> = <span class="keyword">$this</span>-&gt;makeConfig(<span class="string">&#x27;$/redmarlin/shopclerk/models/product/filter_relation.yaml&#x27;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Use Filter widgets to make the widget and bind it to the controller</span></span><br><span class="line">    <span class="variable">$filterWidget</span> = <span class="keyword">$this</span>-&gt;makeWidget(<span class="string">&#x27;Backend\Widgets\Filter&#x27;</span>, <span class="variable">$filterConfig</span>);</span><br><span class="line">    <span class="variable">$filterWidget</span>-&gt;bindToController();</span><br><span class="line"></span><br><span class="line">    <span class="comment"># We need to bind to filter.update event in order to refresh the list after selecting </span></span><br><span class="line">    <span class="comment"># the desired filters.</span></span><br><span class="line">    <span class="variable">$filterWidget</span>-&gt;bindEvent(<span class="string">&#x27;filter.update&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="keyword">use</span> (<span class="params"><span class="variable">$widget_product</span>, <span class="variable">$filterWidget</span></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$widget_product</span>-&gt;onRefresh();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Finally we are attaching The Filter widget to the Product widget.</span></span><br><span class="line">    <span class="variable">$widget_product</span>-&gt;addFilter([<span class="variable">$filterWidget</span>, <span class="string">&#x27;applyAllScopesToQuery&#x27;</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">$this</span>-&gt;productFilterWidget = <span class="variable">$filterWidget</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Dont forget to bind the whole thing to the controller</span></span><br><span class="line">    <span class="variable">$widget_product</span>-&gt;bindToController();</span><br><span class="line"></span><br><span class="line">    <span class="comment">#Return the prepared widget object</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$widget_product</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function that will extend default Product query and only show active products </span></span><br><span class="line"></span><br><span class="line">     <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">productExtendQuery</span>(<span class="params"><span class="variable">$query</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$query</span>-&gt;where(<span class="string">&#x27;status&#x27;</span>,<span class="string">&#x27;active&#x27;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>That is basically all that is needed in the Orders controller. But we are still a few things short. We need a partial that we have declared in our Ajax Handler (onAddProduct) - “product_custom_list”.<br>Create a file <code>_product_custom_list.htm</code> in Controllers/orders/ directory. The code in this file is basically copied from the RelationController partial for managing pivot relation (<code>modules/backend/behaviors/relationcontroller/partials/_manage_pivot.htm</code>). If you need code for other relation type just copy appropriate file from RelationController dir and then modify it to suit your needs. In the first line, by using the <code>data-request-data</code> we are telling relation controller what relation we are displaying here. Apart from that we are rendering Filter and List widget.</p>
<p>I have also customized a few other things here like: removed search widget and removed parts I wont use (ie the list will be always rendered with checkboxes).</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=<span class="string">&quot;relationManagePopup&quot;</span> data-request-data=<span class="string">&quot;_relation_field: &#x27;product&#x27;&quot;</span>&gt;</span><br><span class="line">    <span class="meta">&lt;?=</span> Form::open() <span class="meta">?&gt;</span></span><br><span class="line">        &lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">modal</span>-<span class="title">header</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">button</span> <span class="title">type</span>=&quot;<span class="title">button</span>&quot; <span class="title">class</span>=&quot;<span class="title">close</span>&quot; <span class="title">data</span>-<span class="title">dismiss</span>=&quot;<span class="title">popup</span>&quot;&gt;×&lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">h4</span> <span class="title">class</span>=&quot;<span class="title">modal</span>-<span class="title">title</span>&quot;&gt;<span class="title">Product</span> <span class="title">Selection</span> <span class="title">List</span>&lt;/<span class="title">h4</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">list</span>-<span class="title">flush</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;?<span class="title">php</span> <span class="title">if</span> ($<span class="title">productFilterWidget</span>): ?&gt;</span></span><br><span class="line"><span class="class">                &lt;?= $<span class="title">productFilterWidget</span>-&gt;<span class="title">render</span>() ?&gt;</span></span><br><span class="line"><span class="class">            &lt;?<span class="title">php</span> <span class="title">endif</span> ?&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">        &lt;?= $<span class="title">productListWidget</span>-&gt;<span class="title">render</span>() ?&gt;</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">        &lt;<span class="title">div</span> <span class="title">class</span>=&quot;<span class="title">modal</span>-<span class="title">footer</span>&quot;&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">button</span></span></span><br><span class="line"><span class="class">                    <span class="title">type</span>=&quot;<span class="title">button</span>&quot;</span></span><br><span class="line"><span class="class">                    <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">primary</span>&quot;</span></span><br><span class="line"><span class="class">                    <span class="title">data</span>-<span class="title">control</span>=&quot;<span class="title">popup</span>&quot;</span></span><br><span class="line"><span class="class">                    <span class="title">data</span>-<span class="title">handler</span>=&quot;<span class="title">onRelationManageAddPivot</span>&quot;</span></span><br><span class="line"><span class="class">                    <span class="title">data</span>-<span class="title">size</span>=&quot;<span class="title">huge</span>&quot;</span></span><br><span class="line"><span class="class">                    <span class="title">data</span>-<span class="title">dismiss</span>=&quot;<span class="title">popup</span>&quot;</span></span><br><span class="line"><span class="class">                    <span class="title">data</span>-<span class="title">stripe</span>-<span class="title">load</span>-<span class="title">indicator</span>&gt;</span></span><br><span class="line"><span class="class">                    &lt;?= <span class="title">e</span>(<span class="title">trans</span>(&#x27;<span class="title">backend</span>::<span class="title">lang</span>.<span class="title">relation</span>.<span class="title">add_selected</span>&#x27;)) ?&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">            &lt;<span class="title">button</span></span></span><br><span class="line"><span class="class">                <span class="title">type</span>=&quot;<span class="title">button</span>&quot;</span></span><br><span class="line"><span class="class">                <span class="title">class</span>=&quot;<span class="title">btn</span> <span class="title">btn</span>-<span class="title">default</span>&quot;</span></span><br><span class="line"><span class="class">                <span class="title">data</span>-<span class="title">dismiss</span>=&quot;<span class="title">popup</span>&quot;&gt;</span></span><br><span class="line"><span class="class">                &lt;?= <span class="title">e</span>(<span class="title">trans</span>(&#x27;<span class="title">backend</span>::<span class="title">lang</span>.<span class="title">relation</span>.<span class="title">cancel</span>&#x27;)) ?&gt;</span></span><br><span class="line"><span class="class">            &lt;/<span class="title">button</span>&gt;</span></span><br><span class="line"><span class="class">        &lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">    &lt;?= <span class="title">Form</span>::<span class="title">close</span>() ?&gt;</span></span><br><span class="line"><span class="class">&lt;/<span class="title">div</span>&gt;</span></span><br><span class="line"><span class="class">&lt;<span class="title">script</span>&gt;</span></span><br><span class="line"><span class="class">    <span class="title">setTimeout</span>(</span></span><br><span class="line"><span class="class">            <span class="title">function</span>()</span>&#123; $(<span class="string">&#x27;#relationManagePivotPopup input.form-control:first&#x27;</span>).focus() &#125;,</span><br><span class="line">            <span class="number">310</span></span><br><span class="line">    )</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>If you need search widget you need to add it the same way we added Filter widget.</p>
<p>With this we can render Products list with working filters in the Orders update/create screen as relation. After choosing Product from the list a pivot create form will be shown.</p>
<p>But there is still a tiny detail we should take care of. When using group type filter the dropdown list will be shown below our modal window. In other words it will be invisible!!! You can fix it with just one line of css. You need to change z-index of “control-popover” class to show it above the modal window. something like:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">div.control-popover &#123;</span><br><span class="line">z-index: <span class="number">9999</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>will do. Then I simply injected css file from plugin/assets/backend_mods.css into Orders controller. But you can inject it globally in the Plugin.php. This way you don’t need to add it in every controller.<br>That’s it, I hope you’ll find this tutorial helpful. Let me know if I got something wrong or something is not clear enough.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://redmarlin.net/blog/category/octobercms">https://redmarlin.net/blog/category/octobercms</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2023/02/28/Nativefier%E6%8A%8A%E7%BD%91%E9%A1%B5%E6%89%93%E5%8C%85%E6%88%90%E6%A1%8C%E9%9D%A2%E5%BA%94%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/28/Nativefier%E6%8A%8A%E7%BD%91%E9%A1%B5%E6%89%93%E5%8C%85%E6%88%90%E6%A1%8C%E9%9D%A2%E5%BA%94%E7%94%A8/" class="post-title-link" itemprop="url">Nativefier把网页打包成桌面应用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-28 17:24:41" itemprop="dateCreated datePublished" datetime="2023-02-28T17:24:41+09:00">2023-02-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-03-03 11:14:24" itemprop="dateModified" datetime="2023-03-03T11:14:24+09:00">2023-03-03</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
我们素未谋面，但我希望你平平安安
</blockquote>

<h3 id="安装nodejs"><a href="#安装nodejs" class="headerlink" title="安装nodejs"></a>安装nodejs</h3><h3 id="安装Nativefier"><a href="#安装Nativefier" class="headerlink" title="安装Nativefier"></a>安装Nativefier</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install nativefier -g</span><br><span class="line">//macOS下可能会发生访问某个目录权限不够的问题，因此以管理员身份执行</span><br><span class="line">sudo npm install nativefier -g</span><br></pre></td></tr></table></figure>

<h3 id="参数介绍"><a href="#参数介绍" class="headerlink" title="参数介绍"></a>参数介绍</h3><h4 id="Version"><a href="#Version" class="headerlink" title="Version"></a>Version</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-v, --version</span><br></pre></td></tr></table></figure>


<h4 id="icon"><a href="#icon" class="headerlink" title="[icon]"></a>[icon]</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-i, --icon &lt;path&gt;</span><br></pre></td></tr></table></figure>

<h4 id="strict-internal-urls"><a href="#strict-internal-urls" class="headerlink" title="[strict-internal-urls]"></a>[strict-internal-urls]</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--strict-internal-urls</span><br></pre></td></tr></table></figure>

<p>Disables base domain matching when determining if a link is internal.  Only the <code>--internal-urls</code> regex and login pages will be matched against, so <code>app.foo.com</code> will be external to <code>www.foo.com</code> unless it matches the <code>--internal-urls</code> regex.</p>
<h3 id="生成桌面应用"><a href="#生成桌面应用" class="headerlink" title="生成桌面应用"></a>生成桌面应用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//nativefier --help 帮助文档</span><br><span class="line">nativefier --name &quot;Teambition&quot; &quot;https://www.teambition.com&quot;</span><br><span class="line">//针对M1版本mac可选arm64</span><br><span class="line">nativefier -n &quot;Teambition&quot; -a &quot;arm64&quot; &quot;https://www.teambition.com&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/nativefier/nativefier/">https://github.com/nativefier/nativefier/</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2023/02/06/Mac%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E7%BB%88%E7%AB%AF%E7%A5%9E%E5%99%A8ohmyzsh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/02/06/Mac%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E7%BB%88%E7%AB%AF%E7%A5%9E%E5%99%A8ohmyzsh/" class="post-title-link" itemprop="url">Mac环境安装终端神器ohmyzsh</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-02-06 22:54:16" itemprop="dateCreated datePublished" datetime="2023-02-06T22:54:16+09:00">2023-02-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-02-07 13:04:52" itemprop="dateModified" datetime="2023-02-07T13:04:52+09:00">2023-02-07</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
一定要爱着点什么，恰似草木对光阴的钟情
</blockquote>

<h3 id="第一步，安装-HomeBrew"><a href="#第一步，安装-HomeBrew" class="headerlink" title="第一步，安装 HomeBrew"></a>第一步，安装 HomeBrew</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">bin</span>/ruby -e <span class="string">&quot;$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="第二步，更新-zsh、git"><a href="#第二步，更新-zsh、git" class="headerlink" title="第二步，更新 zsh、git"></a>第二步，更新 zsh、git</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">brew install zsh</span><br><span class="line"></span><br><span class="line">==&gt; Downloading https://homebrew.bintray.com/bottles/zsh-<span class="number">5.7</span><span class="number">.1</span>.high_sierra.bottle.tar.gz</span><br><span class="line"><span class="comment">######################################################################## 100.0%</span></span><br><span class="line">==&gt; Pouring zsh-<span class="number">5.7</span><span class="number">.1</span>.high_sierra.bottle.tar.gz</span><br><span class="line">/usr/local/Cellar/zsh/<span class="number">5.7</span><span class="number">.1</span>: <span class="number">1</span>,<span class="number">515</span> files, <span class="number">13.3</span>MB</span><br></pre></td></tr></table></figure>

<h3 id="第三步，切换至-zsh-并安装-oh-my-zsh"><a href="#第三步，切换至-zsh-并安装-oh-my-zsh" class="headerlink" title="第三步，切换至 zsh 并安装 oh-my-zsh"></a>第三步，切换至 zsh 并安装 oh-my-zsh</h3><p>查看当前使用的 shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo $SHELL</span><br><span class="line"></span><br><span class="line">/<span class="built_in">bin</span>/bash</span><br></pre></td></tr></table></figure>
<p>查看安装的 shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/shells</span><br><span class="line"></span><br><span class="line">/<span class="built_in">bin</span>/bash</span><br><span class="line">/<span class="built_in">bin</span>/csh</span><br><span class="line">/<span class="built_in">bin</span>/ksh</span><br><span class="line">/<span class="built_in">bin</span>/sh</span><br><span class="line">/<span class="built_in">bin</span>/tcsh</span><br><span class="line">/<span class="built_in">bin</span>/zsh</span><br></pre></td></tr></table></figure>
<p>切换为 zsh</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chsh -s /<span class="built_in">bin</span>/zsh</span><br></pre></td></tr></table></figure>
<p>接下来安装 oh-my-zsh</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh -c <span class="string">&quot;$(curl -fsSL https://raw.github.com/robbyrussell/oh-my-zsh/master/tools/install.sh)&quot;</span></span><br></pre></td></tr></table></figure>
<p>安装完成后，终端展示如下内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  ____  / /_     ____ ___  __  __   ____  _____/ /_  </span><br><span class="line"> / __ \/ __ \   / __ `__ \/ / / /  /_  / / ___/ __ \ </span><br><span class="line">/ /_/ / / / /  / / / / / / /_/ /    / /_(__  ) / / / </span><br><span class="line">\____/_/ /_/  /_/ /_/ /_/\__, /    /___/____/_/ /_/  </span><br><span class="line">                        /____/                       ....<span class="keyword">is</span> now installed!</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Please look over the ~/.zshrc file to select plugins, themes, <span class="keyword">and</span> options.</span><br><span class="line"></span><br><span class="line">p.s. Follow us at https://twitter.com/ohmyzsh.</span><br><span class="line"></span><br><span class="line">p.p.s. Get stickers <span class="keyword">and</span> t-shirts at http://shop.planetargon.com.</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="第四步，配置-oh-my-zsh"><a href="#第四步，配置-oh-my-zsh" class="headerlink" title="第四步，配置 oh-my-zsh"></a>第四步，配置 oh-my-zsh</h3><p>打开 oh-my-zsh 配置文件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 打开 zshrc 文件进行编辑，也可以使用 vim 编辑器</span></span><br><span class="line"><span class="built_in">open</span> ~/.zshrc</span><br><span class="line"><span class="comment"># 本人使用的是 vs code</span></span><br><span class="line"><span class="built_in">open</span> ~/.zshrc -a Visual\ Studio\ Code</span><br></pre></td></tr></table></figure>
<p>主题<br>配置项 ZSH_THEME 即为 oh-my-zsh 的主题配置，oh-my-zsh 的 GitHub Wiki 页面提供了 主题列表<br>当设置为 ZSH_THEME=random 时，每次打开终端都会使用一种随机的主题。</p>
<p>插件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plugins=(git osx autojump zsh-autosuggestions zsh-syntax-highlighting)</span><br></pre></td></tr></table></figure>
<p>注意：其中 zsh-autosuggestions 和 zsh-syntax-highlighting 是自定义安装的插件，需要用 git 将插件 clone 到指定插件目录下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 自动提示插件</span></span><br><span class="line">git clone git://github.com/zsh-users/zsh-autosuggestions $ZSH_CUSTOM/plugins/zsh-autosuggestions</span><br><span class="line"><span class="comment"># 语法高亮插件</span></span><br><span class="line">git clone git://github.com/zsh-users/zsh-syntax-highlighting $ZSH_CUSTOM/plugins/zsh-syntax-highlighting</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>需要其他插件的可以自行安装，如果插件未安装，开启终端的时候会报错，按照错误提示，安装对应的插件即可。</p>
<p>更新配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.zshrc</span><br></pre></td></tr></table></figure>

<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>更新完 zsh 说我目录权限问题的解决</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod <span class="number">755</span> /Users/yangzie/.oh-my-zsh/plugins/zsh-syntax-highlighting</span><br><span class="line">chmod <span class="number">755</span> /Users/yangzie/.oh-my-zsh/plugins/zsh-autosuggestions</span><br></pre></td></tr></table></figure>


<blockquote>
<p><a target="_blank" rel="noopener" href="https://a1049145827.github.io/2019/05/15/Mac-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%BB%88%E7%AB%AF%E7%A5%9E%E5%99%A8-oh-my-zsh/">https://a1049145827.github.io/2019/05/15/Mac-%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%B9%B6%E9%85%8D%E7%BD%AE%E7%BB%88%E7%AB%AF%E7%A5%9E%E5%99%A8-oh-my-zsh/</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2022/12/05/parsing-xml-fiels-with-golang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/12/05/parsing-xml-fiels-with-golang/" class="post-title-link" itemprop="url">parsing-xml-fiels-with-golang</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-12-05 18:37:12 / 修改时间：18:42:58" itemprop="dateCreated datePublished" datetime="2022-12-05T18:37:12+09:00">2022-12-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
　No I can't stop
</blockquote>

<h3 id="Our-Example-XML-File"><a href="#Our-Example-XML-File" class="headerlink" title="Our Example XML File"></a>Our Example XML File</h3><p>So to begin with, we’ll need an xml file that we can traverse.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">user</span> <span class="attr">type</span>=<span class="string">&quot;admin&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Elliot<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">social</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">facebook</span>&gt;</span>https://facebook.com<span class="tag">&lt;/<span class="name">facebook</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">twitter</span>&gt;</span>https://twitter.com<span class="tag">&lt;/<span class="name">twitter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">youtube</span>&gt;</span>https://youtube.com<span class="tag">&lt;/<span class="name">youtube</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">social</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">user</span> <span class="attr">type</span>=<span class="string">&quot;reader&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Fraser<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">social</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">facebook</span>&gt;</span>https://facebook.com<span class="tag">&lt;/<span class="name">facebook</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">twitter</span>&gt;</span>https://twitter.com<span class="tag">&lt;/<span class="name">twitter</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">youtube</span>&gt;</span>https://youtube.com<span class="tag">&lt;/<span class="name">youtube</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">social</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>You’ll see the above xml has attributes set on the user tags, nested elements and if you are able to parse this then you should, by extension, be able to parse any xml file regardless of size.</p>
<h3 id="Reading-in-our-File"><a href="#Reading-in-our-File" class="headerlink" title="Reading in our File"></a>Reading in our File</h3><p>The first obstacle we’ll have to overcome is reading this file into memory. We can do this by using a combination of the “os” package and the “io/ioutil” package.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open our xmlFile</span></span><br><span class="line">    xmlFile, err := os.Open(<span class="string">&quot;users.xml&quot;</span>)</span><br><span class="line">    <span class="comment">// if we os.Open returns an error then handle it</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;Successfully Opened users.xml&quot;</span>)</span><br><span class="line">    <span class="comment">// defer the closing of our xmlFile so that we can parse it later on</span></span><br><span class="line">    <span class="keyword">defer</span> xmlFile.Close()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Defining-our-Structs"><a href="#Defining-our-Structs" class="headerlink" title="Defining our Structs"></a>Defining our Structs</h3><p>Before we can parse our xml file, we need to define some structs. We’ll have one to represent the complete list of users, one to represent our user and then one to represent our users social links.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// remember to add encoding/xml to your list of imports</span></span><br><span class="line">    <span class="string">&quot;encoding/xml&quot;</span></span><br><span class="line">    ...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// our struct which contains the complete</span></span><br><span class="line"><span class="comment">// array of all Users in the file</span></span><br><span class="line"><span class="keyword">type</span> Users <span class="keyword">struct</span> &#123;</span><br><span class="line">    XMLName xml.Name <span class="string">`xml:&quot;users&quot;`</span></span><br><span class="line">    Users   []User   <span class="string">`xml:&quot;user&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the user struct, this contains our</span></span><br><span class="line"><span class="comment">// Type attribute, our user&#x27;s name and</span></span><br><span class="line"><span class="comment">// a social struct which will contain all</span></span><br><span class="line"><span class="comment">// our social links</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    XMLName xml.Name <span class="string">`xml:&quot;user&quot;`</span></span><br><span class="line">    Type    <span class="keyword">string</span>   <span class="string">`xml:&quot;type,attr&quot;`</span></span><br><span class="line">    Name    <span class="keyword">string</span>   <span class="string">`xml:&quot;name&quot;`</span></span><br><span class="line">    Social  Social   <span class="string">`xml:&quot;social&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a simple struct which contains all our</span></span><br><span class="line"><span class="comment">// social links</span></span><br><span class="line"><span class="keyword">type</span> Social <span class="keyword">struct</span> &#123;</span><br><span class="line">    XMLName  xml.Name <span class="string">`xml:&quot;social&quot;`</span></span><br><span class="line">    Facebook <span class="keyword">string</span>   <span class="string">`xml:&quot;facebook&quot;`</span></span><br><span class="line">    Twitter  <span class="keyword">string</span>   <span class="string">`xml:&quot;twitter&quot;`</span></span><br><span class="line">    Youtube  <span class="keyword">string</span>   <span class="string">`xml:&quot;youtube&quot;`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Unmarshalling-Our-XML"><a href="#Unmarshalling-Our-XML" class="headerlink" title="Unmarshalling Our XML"></a>Unmarshalling Our XML</h3><p>So above we’ve seen how to load in our file into memory, in order to marshal it we need to convert this file to a byte array and then use the xml.Unmarshal method in order to populate our Users array.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// read our opened xmlFile as a byte array.</span></span><br><span class="line">byteValue, _ := ioutil.ReadAll(xmlFile)</span><br><span class="line"></span><br><span class="line"><span class="comment">// we initialize our Users array</span></span><br><span class="line"><span class="keyword">var</span> users Users</span><br><span class="line"><span class="comment">// we unmarshal our byteArray which contains our</span></span><br><span class="line"><span class="comment">// xmlFiles content into &#x27;users&#x27; which we defined above</span></span><br><span class="line">xml.Unmarshal(byteValue, &amp;users)</span><br></pre></td></tr></table></figure>

<h3 id="Full-Implementation"><a href="#Full-Implementation" class="headerlink" title="Full Implementation"></a>Full Implementation</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/xml&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// our struct which contains the complete</span></span><br><span class="line"><span class="comment">// array of all Users in the file</span></span><br><span class="line"><span class="keyword">type</span> Users <span class="keyword">struct</span> &#123;</span><br><span class="line">    XMLName xml.Name <span class="string">`xml:&quot;users&quot;`</span></span><br><span class="line">    Users   []User   <span class="string">`xml:&quot;user&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// the user struct, this contains our</span></span><br><span class="line"><span class="comment">// Type attribute, our user&#x27;s name and</span></span><br><span class="line"><span class="comment">// a social struct which will contain all</span></span><br><span class="line"><span class="comment">// our social links</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span> &#123;</span><br><span class="line">    XMLName xml.Name <span class="string">`xml:&quot;user&quot;`</span></span><br><span class="line">    Type    <span class="keyword">string</span>   <span class="string">`xml:&quot;type,attr&quot;`</span></span><br><span class="line">    Name    <span class="keyword">string</span>   <span class="string">`xml:&quot;name&quot;`</span></span><br><span class="line">    Social  Social   <span class="string">`xml:&quot;social&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// a simple struct which contains all our</span></span><br><span class="line"><span class="comment">// social links</span></span><br><span class="line"><span class="keyword">type</span> Social <span class="keyword">struct</span> &#123;</span><br><span class="line">    XMLName  xml.Name <span class="string">`xml:&quot;social&quot;`</span></span><br><span class="line">    Facebook <span class="keyword">string</span>   <span class="string">`xml:&quot;facebook&quot;`</span></span><br><span class="line">    Twitter  <span class="keyword">string</span>   <span class="string">`xml:&quot;twitter&quot;`</span></span><br><span class="line">    Youtube  <span class="keyword">string</span>   <span class="string">`xml:&quot;youtube&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open our xmlFile</span></span><br><span class="line">    xmlFile, err := os.Open(<span class="string">&quot;users.xml&quot;</span>)</span><br><span class="line">    <span class="comment">// if we os.Open returns an error then handle it</span></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;Successfully Opened users.xml&quot;</span>)</span><br><span class="line">    <span class="comment">// defer the closing of our xmlFile so that we can parse it later on</span></span><br><span class="line">    <span class="keyword">defer</span> xmlFile.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// read our opened xmlFile as a byte array.</span></span><br><span class="line">    byteValue, _ := ioutil.ReadAll(xmlFile)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we initialize our Users array</span></span><br><span class="line">    <span class="keyword">var</span> users Users</span><br><span class="line">    <span class="comment">// we unmarshal our byteArray which contains our</span></span><br><span class="line">    <span class="comment">// xmlFiles content into &#x27;users&#x27; which we defined above</span></span><br><span class="line">    xml.Unmarshal(byteValue, &amp;users)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// we iterate through every user within our users array and</span></span><br><span class="line">    <span class="comment">// print out the user Type, their name, and their facebook url</span></span><br><span class="line">    <span class="comment">// as just an example</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(users.Users); i++ &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;User Type: &quot;</span> + users.Users[i].Type)</span><br><span class="line">        fmt.Println(<span class="string">&quot;User Name: &quot;</span> + users.Users[i].Name)</span><br><span class="line">        fmt.Println(<span class="string">&quot;Facebook Url: &quot;</span> + users.Users[i].Social.Facebook)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://tutorialedge.net/golang/parsing-xml-with-golang/">https://tutorialedge.net/golang/parsing-xml-with-golang/</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2022/11/10/how-to-safely-append-data-to-the-same-slice-concurrently-in-golang/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/11/10/how-to-safely-append-data-to-the-same-slice-concurrently-in-golang/" class="post-title-link" itemprop="url">how-to-safely-append-data-to-the-same-slice-concurrently-in-golang</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-11-10 13:39:19 / 修改时间：13:52:49" itemprop="dateCreated datePublished" datetime="2022-11-10T13:39:19+09:00">2022-11-10</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
活着是世界上最罕见的事，

<p>大多数人只是存在，仅此而已。</p>
</blockquote>

<p>In this article, we’ll go through different ways to implement like wait groups and mutex and the challenges of data race.</p>
<p>Aim : A program that separates odd and even number from 0to 9 an appends it into their corresponding slices. So we should have odd=[1,3,5,7,9] (in any order) and even=[0,2,4,6,8] (in any order).</p>
<h3 id="Attempt-0-Only-with-goroutines"><a href="#Attempt-0-Only-with-goroutines" class="headerlink" title="Attempt-0 Only with goroutines"></a>Attempt-0 Only with goroutines</h3><p>Background : The only goroutine that a program has at startup is the one that calls the main function, thus we refer to it as the main goroutine. The go statement generates new goroutines. A go statement is a regular function or method call that has the keyword go prefixed to it. A go statement causes a newly formed goroutine to call the function. The go statement itself is immediately finished.</p>
<p>In this we are appending to the slice using multiple go routines. So we’ll have a main go routines and 10 new go routines created by anonymous go function.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">done</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> odd = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line"> <span class="keyword">var</span> even = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="number">9</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    even = <span class="built_in">append</span>(even, i)</span><br><span class="line">   &#125;(i)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    odd = <span class="built_in">append</span>(odd, i)</span><br><span class="line">   &#125;(i)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> fmt.Println(odd)</span><br><span class="line"> fmt.Println(even)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line">  done()</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span>]               </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">8</span>]                 </span><br><span class="line">========================</span><br><span class="line">[<span class="number">7</span> <span class="number">5</span> <span class="number">3</span>]                 </span><br><span class="line">[<span class="number">4</span> <span class="number">6</span> <span class="number">0</span> <span class="number">2</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span>]                 </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span>]               </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span>]                 </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span>]               </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span>]               </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span>]                 </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]</span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]</span><br></pre></td></tr></table></figure>
<p>Major issues :</p>
<ul>
<li>The main goroutine can complete it’s execution without waiting for the other go routines (who will append the data in slices)to complete. As a result print statement in the main go routine will the slices where the data is still being appended by other go routines.</li>
<li>Data race (we’ll cover in the next part)</li>
</ul>
<h3 id="Attempt-1-With-sync-waitgroups"><a href="#Attempt-1-With-sync-waitgroups" class="headerlink" title="Attempt-1 With sync.waitgroups"></a>Attempt-1 With sync.waitgroups</h3><p>We’ll use sync.waitgroups. With the help of the WaitGroup function in the sync package, a program can wait for particular goroutines. These Golang sync techniques halt programme execution until goroutines in the WaitGroup have finished running.</p>
<p>In a nutshell, the main program will wait till all the other go routines have finished.</p>
<p>WaitGroup is informed by wg.Add(1) that it needs to wait for one more goroutine every time loop starts. After that, defer wg.Done() alerts the WaitGroup when a goroutine is finished. Then, wg.Wait() delays the execution until the goroutines have finished running. The entire procedure resembles increasing a counter in wgAdd() deducts from the wg counter. Waiting for the counter in wg to reach 0 while calling done(). This is the crux how wait groups work.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"> <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">done</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"> <span class="keyword">var</span> odd = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line"> <span class="keyword">var</span> even = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="number">9</span>; i++ &#123;</span><br><span class="line">  wg.Add(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    even = <span class="built_in">append</span>(even, i)</span><br><span class="line">   &#125;(i)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    odd = <span class="built_in">append</span>(odd, i)</span><br><span class="line">   &#125;(i)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> wg.Wait()</span><br><span class="line"> fmt.Println(odd)</span><br><span class="line"> fmt.Println(even)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line">  done()</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Output</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span> <span class="number">9</span>]             </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">9</span>]                 </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">9</span> <span class="number">5</span> <span class="number">7</span> <span class="number">1</span> <span class="number">3</span>]             </span><br><span class="line">[<span class="number">6</span> <span class="number">8</span> <span class="number">0</span> <span class="number">2</span> <span class="number">4</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span> <span class="number">9</span>]             </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span> <span class="number">9</span>]             </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">8</span>]               </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">9</span> <span class="number">7</span>]             </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span> <span class="number">9</span>]             </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">9</span> <span class="number">1</span> <span class="number">3</span> <span class="number">5</span> <span class="number">7</span>]             </span><br><span class="line">[<span class="number">0</span> <span class="number">2</span> <span class="number">4</span> <span class="number">6</span> <span class="number">8</span>]             </span><br><span class="line">========================</span><br><span class="line">[<span class="number">3</span> <span class="number">9</span> <span class="number">1</span> <span class="number">5</span> <span class="number">7</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">4</span> <span class="number">2</span> <span class="number">6</span> <span class="number">8</span>]</span><br><span class="line">========================</span><br><span class="line">[<span class="number">9</span> <span class="number">1</span> <span class="number">7</span> <span class="number">3</span> <span class="number">5</span>]</span><br><span class="line">[<span class="number">0</span> <span class="number">6</span> <span class="number">8</span> <span class="number">2</span> <span class="number">4</span>]</span><br></pre></td></tr></table></figure>
<p>What’s happening now?<br>To make sure the function was consistent, we ran it ten times. It undoubtedly outperforms the old one, but occasionally the results are not what was anticipated. So what’s the reason. The reason is data race .</p>
<p>Data race : When two or more Goroutines access the same memory location, at least one of them is a write, and there is no ordering between them, this is referred to as a data race.</p>
<p>In simpler terms, you have a race condition with multiple goroutines writing a slice concurrently. The behavior will be unpredictable. You need a mutex. Protect the appends by lock.</p>
<p>We can confirm this by command go run -race pgm3b.go</p>
<h3 id="Attempt-2-With-sync-waitgroups-and-mutex"><a href="#Attempt-2-With-sync-waitgroups-and-mutex" class="headerlink" title="Attempt-2 With sync.waitgroups and mutex"></a>Attempt-2 With sync.waitgroups and mutex</h3><p>We’ll use mutex with sync.waitgroups. This not only ensures that the main go routine waits till all other 10 go routines complete but it also ensures that at a given point of time only one go routine can write in a slice. This is the principle of mutual exclusion or mutex. Appends are protected by mutex avoiding dirty write case.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"> <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">done</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">type</span> answer <span class="keyword">struct</span> &#123;</span><br><span class="line">  MU   sync.Mutex</span><br><span class="line">  data []<span class="keyword">int</span></span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">var</span> odd answer</span><br><span class="line"> <span class="keyword">var</span> even answer</span><br><span class="line">wg := &amp;sync.WaitGroup&#123;&#125;</span><br><span class="line"> <span class="keyword">for</span> i := <span class="number">0</span>; i &lt;= <span class="number">9</span>; i++ &#123;</span><br><span class="line">  <span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">0</span> &#123;</span><br><span class="line">   wg.Add(<span class="number">1</span>)</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">even.MU.Lock()</span><br><span class="line">    even.data = <span class="built_in">append</span>(even.data, i)</span><br><span class="line">    even.MU.Unlock()</span><br><span class="line">   &#125;(i)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> i%<span class="number">2</span> == <span class="number">1</span> &#123;</span><br><span class="line">   wg.Add(<span class="number">1</span>)</span><br><span class="line">   <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(i <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">odd.MU.Lock()</span><br><span class="line">    odd.data = <span class="built_in">append</span>(odd.data, i)</span><br><span class="line">    odd.MU.Unlock()</span><br><span class="line">   &#125;(i)</span><br><span class="line">  &#125;</span><br><span class="line"> &#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">fmt.Println(odd.data)</span><br><span class="line">fmt.Println(even.data)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">10</span>; i++ &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;========================&quot;</span>)</span><br><span class="line">  done()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>output</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">========================</span><br><span class="line">[1 9 5 3 7]             </span><br><span class="line">[0 4 2 6 8]             </span><br><span class="line">========================</span><br><span class="line">[5 9 3 7 1]             </span><br><span class="line">[2 0 8 6 4]             </span><br><span class="line">========================</span><br><span class="line">[1 3 5 7 9]             </span><br><span class="line">[2 0 4 6 8]             </span><br><span class="line">========================</span><br><span class="line">[1 3 5 7 9]             </span><br><span class="line">[0 2 4 6 8]             </span><br><span class="line">========================</span><br><span class="line">[1 3 5 7 9]             </span><br><span class="line">[0 2 4 6 8]             </span><br><span class="line">========================</span><br><span class="line">[1 3 5 7 9]             </span><br><span class="line">[2 0 4 6 8]             </span><br><span class="line">========================</span><br><span class="line">[1 3 5 7 9]             </span><br><span class="line">[0 2 4 6 8]             </span><br><span class="line">========================</span><br><span class="line">[3 1 9 7 5]             </span><br><span class="line">[0 2 4 6 8]             </span><br><span class="line">========================</span><br><span class="line">[9 5 7 1 3]</span><br><span class="line">[6 8 4 2 0]</span><br><span class="line">========================</span><br><span class="line">[1 3 5 7 9]</span><br><span class="line">[0 2 4 6 8]</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.devgenius.io/how-to-safely-append-data-to-the-same-slice-concurrently-in-golang-df467e1ebc9c">https://blog.devgenius.io/how-to-safely-append-data-to-the-same-slice-concurrently-in-golang-df467e1ebc9c</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2022/10/21/MySQL%E9%94%99%E8%AF%AFDuplicate-entry-for%E2%80%94key-group-key/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/21/MySQL%E9%94%99%E8%AF%AFDuplicate-entry-for%E2%80%94key-group-key/" class="post-title-link" itemprop="url">MySQL错误Duplicate-entry-for—key-group-key</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-10-21 17:09:00 / 修改时间：17:25:08" itemprop="dateCreated datePublished" datetime="2022-10-21T17:09:00+09:00">2022-10-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
今生无悔入华夏，来生还做中国人！
</blockquote>

<h3 id="问题背景"><a href="#问题背景" class="headerlink" title="问题背景"></a>问题背景</h3><p>有一个数据表，记录一个QQ号加好友的活跃天数、加好友次数、加好友的toUin数等信息。数据表的建表语句如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;drop table if exists uinPortrait&quot;|mysql -proot@mysql </span><br><span class="line">echo &quot;CREATE TABLE IF NOT EXISTS uinPortrait(</span><br><span class="line">          uin int(10) unsigned NOT NULL DEFAULT 0,</span><br><span class="line">          active_days int(10) unsigned NOT NULL DEFAULT 0,</span><br><span class="line">          add_friend_count int(10) unsigned NOT NULL DEFAULT 0,</span><br><span class="line">          add_friend_uin_count int(10) unsigned NOT NULL DEFAULT 0,</span><br><span class="line">          black_count int(10) unsigned NOT NULL DEFAULT 0,</span><br><span class="line">          black_uin_count int(10) unsigned NOT NULL DEFAULT 0</span><br><span class="line">      )ENGINE=MyISAM DEFAULT CHARSET=utf8&quot; |mysql -proot@mysql </span><br></pre></td></tr></table></figure>

<p>由于数据表中的数据存放形式如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+----------+-------------+------------------+----------------------+------------+-----------------+</span><br><span class="line">| uin      | active_days | add_friend_count | add_friend_uin_count |black_count | black_uin_count |</span><br><span class="line">+----------+-------------+------------------+----------------------+------------+-----------------+</span><br><span class="line">|<span class="number">10000</span>     |<span class="number">1</span>            |<span class="number">2</span>                 |<span class="number">2</span>                     |<span class="number">0</span>           |<span class="number">0</span>                |</span><br><span class="line">|<span class="number">10000</span>     |<span class="number">0</span>            |<span class="number">0</span>                 |<span class="number">0</span>                     |<span class="number">4</span>           |<span class="number">3</span>                |</span><br><span class="line">|<span class="number">10001</span>     |<span class="number">1</span>            |<span class="number">3</span>                 |<span class="number">2</span>                     |<span class="number">0</span>           |<span class="number">0</span>                |</span><br><span class="line">|<span class="number">10001</span>     |<span class="number">0</span>            |<span class="number">0</span>                 |<span class="number">0</span>                     |<span class="number">5</span>           |<span class="number">5</span>                |</span><br><span class="line">....</span><br><span class="line">+----------+-------------+------------------+----------------------+------------+-----------------+</span><br></pre></td></tr></table></figure>
<p>现在需要将相同的UIN数据归并为一条数据，于是使用了如下SQL：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#先建立一张空表</span><br><span class="line">mysql<span class="operator">&gt;</span><span class="keyword">create</span> <span class="keyword">table</span> if <span class="keyword">not</span> <span class="keyword">exists</span> blankUinPortrait <span class="keyword">like</span> uinPortrait;</span><br><span class="line"></span><br><span class="line">mysql<span class="operator">&gt;</span><span class="keyword">insert</span> <span class="keyword">into</span> blankUinPortrait <span class="keyword">select</span> uin,<span class="built_in">sum</span>(active_days),<span class="built_in">sum</span>(add_friend_count),<span class="built_in">sum</span>(add_friend_uin_count),<span class="built_in">sum</span>(black_count),<span class="built_in">sum</span>(black_uin_count) <span class="keyword">from</span> uinPortrait <span class="keyword">group</span> <span class="keyword">by</span> uin;</span><br></pre></td></tr></table></figure>
<p>在执行<code>insert into</code>时，错误如下<code>ERROR 1062 (23000) at line 1: Duplicate entry &#39;1332883220&#39; for key &#39;group_key&#39;</code>。并非每一个uin插入时都报错，只是零星地报几个。</p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h3><p>MySQL版本5.1.61。很疑惑，<code>blankUinPortrait</code>并没有设置主键和唯一索引，不知道为什么会出现值冲突，百思不得其解，在网上各种google和baidu也没有找到原因。于是我尝试了重启mysql、将中间数据写到磁盘，再load到数据表，以及将<code>insert into</code>改为<code>replace into</code>都不行。不抛弃，不放弃，黄天不负有心人，终于在stack overflow社区上找到了解决方法，具体参见<code>Duplicate entry for key ‘group_key’</code>。</p>
<p>具体做法是修改mysql的配置文件，一般在<code>/etc/my.cnf</code>，将<code>max_heap_table_size=536870912</code>和<code>tmp_table_size=536870912</code>添加到<code>/etc/my.cnf</code>中</p>
<p>先说一下<code>tmp_table_size </code><br> 在做GROUP BY操作时会生成临时表，它规定了临时表大小的最大值（实际起限制作用的是<code>tmp_table_size</code>和<code>max_heap_table</code>_size的最小值。）。如果内存临时表超出了限制，MySQL就会自动地把它转化为基于磁盘的MyISAM表，存储在指定的tmpdir目录下。默认：<br> <figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like <span class="string">&quot;tmpdir&quot;</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| tmpdir        | /tmp/ | </span><br><span class="line">+---------------+-------+</span><br></pre></td></tr></table></figure></p>
<p> 如果调高该值，MySQL同时将增加heap表的大小，可达到提高联接查询速度的效果，建议尽量优化查询，要确保查询过程中生成的临时表在内存中，避免临时表过大导致生成基于硬盘的MyISAM表 。<br> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> show global status like ‘created_tmp%‘;</span></span><br><span class="line"></span><br><span class="line">+——————————–+———+</span><br><span class="line"></span><br><span class="line">| Variable_name　　           | Value　|</span><br><span class="line"></span><br><span class="line">+———————————-+———+</span><br><span class="line"></span><br><span class="line">| Created_tmp_disk_tables | 21197  |</span><br><span class="line"></span><br><span class="line">| Created_tmp_files　　　| 58　　|</span><br><span class="line"></span><br><span class="line">| Created_tmp_tables　　| 1771587 |</span><br><span class="line"></span><br><span class="line">+——————————–+———–+</span><br></pre></td></tr></table></figure></p>
<p>每次创建临时表，<code>Created_tmp_tables</code>增加，如果临时表大小超过<code>tmp_table_size</code>，则是在磁盘上创建临时表，<code>Created_tmp_disk_tables</code>也增加，<code>Created_tmp_files</code>表示MySQL服务创建的临时文件文件数，比较理想的配置是：<br><code> Created_tmp_disk_tables / Created_tmp_tables * 100% &lt;= 25%</code>比如上面的服务器<code>Created_tmp_disk_tables / Created_tmp_tables * 100% ＝1.20%</code>，应该比较合适。</p>
<p><code>show variables like &#39;max_table_size&#39;</code>可以查看大小，默认是16MB，可调到64-256MB最佳，线程独占，太大可能导致内存不够，I/O堵塞。</p>
<p>关于max_heap_table_size<br> 这个变量定义了用户可以创建的内存表(memory table)的大小，可用来计算内存表的最大行数值。这个变量支持动态改变，即<code>set @max_heap_table_size=#</code>，但对于已经存在的内存表就没有什么用了，除非这个表被重新创建(create table)或者修改(alter table)或者truncate table。服务重启也会设置已经存在的内存表为全局<code>max_heap_table_size</code>的值。</p>
<p>这个变量和tmp_table_size一起限制了内部内存临时表的大小。具体可参见 Section 8.4.4, “Internal Temporary Table Use in MySQL。</p>
<p><code>show variables like &#39;max_heap_table_size&#39;</code>可以查看大小，默认是16MB。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1176358">https://cloud.tencent.com/developer/article/1176358</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2022/08/29/How-To-Implement-Concurrency-With-Goroutines-and-Channels/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/29/How-To-Implement-Concurrency-With-Goroutines-and-Channels/" class="post-title-link" itemprop="url">How-To-Implement-Concurrency-With-Goroutines-and-Channels</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-08-29 18:10:20 / 修改时间：18:12:55" itemprop="dateCreated datePublished" datetime="2022-08-29T18:10:20+09:00">2022-08-29</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
I wish I could be more like you.
</blockquote>

<h3 id="Sequential-Async-Call"><a href="#Sequential-Async-Call" class="headerlink" title="Sequential Async Call"></a>Sequential Async Call</h3><p>Let’s start with a basic console program that connects to a few website urls and tests if the connection is successful. There are no goroutines at start, and all calls are made in order which is not very efficient.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  start := time.Now()</span><br><span class="line">  links := []<span class="keyword">string</span> &#123;</span><br><span class="line">    <span class="string">&quot;https://go.dev/learn/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.netflix.com/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://go.dev/learn/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.netflix.com/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://go.dev/learn/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.netflix.com/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://github.com/&quot;</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  checkUrls(links)</span><br><span class="line">  fmt.Println(<span class="string">&quot;Completed the code process, took: %f seconds&quot;</span>, time.Since(start).Seconds())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkUrls</span><span class="params">(urls []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  <span class="keyword">for</span> _, link := <span class="keyword">range</span> urls &#123;</span><br><span class="line">    checkUrl(link)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkUrl</span><span class="params">(url <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  _, err := http.Get(url)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;We could not reach: &quot;</span>, url)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Success reaching the website: &quot;</span>, url)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Adding-Concurrency-and-Optimizing-the-code"><a href="#Adding-Concurrency-and-Optimizing-the-code" class="headerlink" title="Adding Concurrency and Optimizing the code"></a>Adding Concurrency and Optimizing the code</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;sync&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/http&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  start := time.Now()</span><br><span class="line">  links := []<span class="keyword">string</span> &#123;</span><br><span class="line">    <span class="string">&quot;https://go.dev/learn/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.netflix.com/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://go.dev/learn/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.netflix.com/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://go.dev/learn/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://www.netflix.com/&quot;</span>,</span><br><span class="line">    <span class="string">&quot;https://github.com/&quot;</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  checkUrls(links)</span><br><span class="line">  fmt.Println(<span class="string">&quot;Completed the code process, took: %f seconds&quot;</span>, time.Since(start).Seconds())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkUrls</span><span class="params">(urls []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">  c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">string</span>)</span><br><span class="line">  <span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> _, link := <span class="keyword">range</span> urls &#123;</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> checkUrl(link, c, &amp;wg)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    <span class="built_in">close</span>(c)</span><br><span class="line">  &#125;()</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> msg := <span class="keyword">range</span> c &#123;</span><br><span class="line">    fmt.Println(msg)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">checkUrl</span><span class="params">(url <span class="keyword">string</span>, c <span class="keyword">chan</span> <span class="keyword">string</span>, wg *sync.WaitGroup)</span></span> &#123;</span><br><span class="line">  <span class="keyword">defer</span> (*wg).Done()</span><br><span class="line">  _, err := http.Get(url)</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;We could not reach: &quot;</span> + url</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    c &lt;- <span class="string">&quot;Success reaching the website: &quot;</span> + url</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://faun.pub/golang-tutorial-how-to-implement-concurrency-with-goroutines-and-channels-67d0f30d9e35">https://faun.pub/golang-tutorial-how-to-implement-concurrency-with-goroutines-and-channels-67d0f30d9e35</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2022/08/27/Dockerize-Go-Application-Easily/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="外贸独立站(日本)">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/27/Dockerize-Go-Application-Easily/" class="post-title-link" itemprop="url">Dockerize-Go-Application-Easily</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-08-27 13:01:37 / 修改时间：13:38:15" itemprop="dateCreated datePublished" datetime="2022-08-27T13:01:37+09:00">2022-08-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
When you become a parent, one thing becomes really clear. <br>
And that's that you want to make sure your children feel safe.
</blockquote>

<p>There are some ways to deploy your Golang code, especially when you are using Docker to run your executable file of your Go Project. We can create our image from our project, and we can simply run it on your local computer, or even on the deployment by pulling your image from the registry.</p>
<h3 id="Requirement"><a href="#Requirement" class="headerlink" title="Requirement"></a>Requirement</h3><ul>
<li>docker</li>
<li>Basic of Go Programming<br>Repository: <a target="_blank" rel="noopener" href="https://github.com/david-yappeter/go-dockerfile-example">https://github.com/david-yappeter/go-dockerfile-example</a></li>
</ul>
<h3 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h3><p>First, you need to start your docker daemon by using <code>systemctl start docker</code> or <code>service docker start</code> , use <code>sudo</code> if needed.</p>
<p>Then we will create our simple go HTTP code.</p>
<p>Then we will create our simple go HTTP code.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir <span class="keyword">go</span>-dockerfile &amp;&amp; cd <span class="keyword">go</span>-dockerfile</span><br><span class="line">$ <span class="keyword">go</span> mod init myapp</span><br><span class="line">$ touch server.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>

<p>server.go:</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">	<span class="string">&quot;github.com/joho/godotenv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">	godotenv.Load()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	port := os.Getenv(<span class="string">&quot;PORT&quot;</span>)</span><br><span class="line">	<span class="keyword">if</span> port == <span class="string">&quot;&quot;</span> &#123;</span><br><span class="line">		port = <span class="string">&quot;8080&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	router := gin.Default()</span><br><span class="line"></span><br><span class="line">	router.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.String(<span class="number">200</span>, <span class="string">&quot;Hello World&quot;</span>)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	router.GET(<span class="string">&quot;/env&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">		c.String(<span class="number">200</span>, <span class="string">&quot;Hello %s&quot;</span>, os.Getenv(<span class="string">&quot;NAME&quot;</span>))</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	router.Run(<span class="string">&quot;:&quot;</span> + port)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Our <code>server.go</code> will contain a simple <code>gin</code> router and optional <code>godotenv</code> .</p>
<p><code>/</code> path will return “Hello World” and <code>/env</code> path will return “Hello ${NAME}”.</p>
<h3 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h3><p>there are several ways to write <code>Dockerfile</code> , but I will make 3 examples with different base images: official golang, alpine, and scratch.</p>
<h4 id="FROM-Official-Image"><a href="#FROM-Official-Image" class="headerlink" title="FROM Official Image"></a>FROM Official Image</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:<span class="number">1.16</span>-alpine</span><br><span class="line"></span><br><span class="line">WORKDIR /project/<span class="keyword">go</span>-docker/</span><br><span class="line"></span><br><span class="line"># COPY <span class="keyword">go</span>.mod, <span class="keyword">go</span>.sum and download the dependencies</span><br><span class="line">COPY <span class="keyword">go</span>.* ./</span><br><span class="line">RUN <span class="keyword">go</span> mod download</span><br><span class="line"></span><br><span class="line"># COPY All things inside the project and build</span><br><span class="line">COPY . .</span><br><span class="line">RUN <span class="keyword">go</span> build -o /project/<span class="keyword">go</span>-docker/build/myapp .</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line">ENTRYPOINT [ <span class="string">&quot;/project/go-docker/build/myapp&quot;</span> ]</span><br></pre></td></tr></table></figure>

<p>In this Dockerfile , we will split it into some sections:</p>
<ul>
<li><code>FROM golang:1.16-alpine</code> , we will use golang:1.16-alpine as the base image of this Docker build.</li>
<li><code>WORKDIR</code> , will be our working directory of our command/path of our next commands.</li>
<li><code>COPY go.* ./</code> , we will copy <code>go.mod</code> &amp; <code>go.sum</code> file from our project to the working directory.</li>
<li><code>RUN go mod download</code> , download the project dependencies from go modules.</li>
<li><code>COPY . .</code> , copy all things from our project into the working directory.</li>
<li><code>RUN go build -o /project/go-docker/build/myapp .</code> , build our project in the working directory and output it in <code>project/go-docker/build/myapp</code> as a binary file.</li>
<li><code>EXPOSE 8080</code> , telling docker that our code will expose port 8080 .</li>
<li><code>ENTRYPOINT [&quot;/project/go-docker/build/myapp&quot;]</code> , when we run the container of this image, it will start from our build binary.</li>
</ul>
<p>Any of these duplicate explanations won’t be explained twice. After this we need to run this command:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -f Dockerfile -t test-go-docker:latest .</span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>-f</code> flag is the filename of our Dockerfile .</p>
</li>
<li><p><code>-t</code> flag is the name of the image later on.</p>
</li>
<li><p><code>.</code> at the end of the command is the directory of the Dockerfile .</p>
</li>
</ul>
<h4 id="Alpine-Base-Image"><a href="#Alpine-Base-Image" class="headerlink" title="Alpine Base Image"></a>Alpine Base Image</h4><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:<span class="number">1.16</span>-alpine as builder</span><br><span class="line"></span><br><span class="line">WORKDIR /project/<span class="keyword">go</span>-docker/</span><br><span class="line"></span><br><span class="line"># COPY <span class="keyword">go</span>.mod, <span class="keyword">go</span>.sum and download the dependencies</span><br><span class="line">COPY <span class="keyword">go</span>.* ./</span><br><span class="line">RUN <span class="keyword">go</span> mod download</span><br><span class="line"></span><br><span class="line"># COPY All things inside the project and build</span><br><span class="line">COPY . .</span><br><span class="line">RUN <span class="keyword">go</span> build -o /project/<span class="keyword">go</span>-docker/build/myapp .</span><br><span class="line"></span><br><span class="line">FROM alpine:latest</span><br><span class="line">COPY --from=builder /project/<span class="keyword">go</span>-docker/build/myapp /project/<span class="keyword">go</span>-docker/build/myapp</span><br><span class="line"></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line">ENTRYPOINT [ <span class="string">&quot;/project/go-docker/build/myapp&quot;</span> ]</span><br></pre></td></tr></table></figure>

<p>The difference from the first one:</p>
<ul>
<li><code>FROM golang:1.16-alpine as builder</code> , we will use golang:1.16-alpine and tag it as builder that later on will be used.</li>
<li><code>FROM alpine:latest</code> , we will create a new base image from alpine .</li>
<li><code>COPY --from=builder /project/go-docker/build/myapp /project/go-docker/build/myapp</code> , copy the build binary file into the new alpine image and run it later on.<br>The image size of this <code>Dockerfile</code> is way smaller than the previous image.</li>
</ul>
<h4 id="FROM-Scratch"><a href="#FROM-Scratch" class="headerlink" title="FROM Scratch"></a>FROM Scratch</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">FROM golang:1.16-alpine as builder</span><br><span class="line"></span><br><span class="line">WORKDIR /project/go-docker/</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> COPY go.mod, go.sum and download the dependencies</span></span><br><span class="line">COPY go.* ./</span><br><span class="line">RUN go mod download</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> COPY All things inside the project and build</span></span><br><span class="line">COPY . .</span><br><span class="line">RUN go build -o /project/go-docker/build/myapp .</span><br><span class="line"></span><br><span class="line">FROM scratch</span><br><span class="line">COPY --from=builder /project/go-docker/build/myapp /project/go-docker/build/myapp</span><br><span class="line"></span><br><span class="line">EXPOSE 8080</span><br><span class="line">ENTRYPOINT [ &quot;/project/go-docker/build/myapp&quot; ]</span><br></pre></td></tr></table></figure>
<p>And for the last Dockerfile, we only change the alpine base image into scratch . Scratch is an empty image, so once the container running, we can’t exec into the container because it doesn’t even have a shell command.</p>
<p>The image is slightly smaller than the alpine base image.</p>
<p>try to run the image by using <code>docker run -d -p 8080:8080 test-go-docker:latest</code> , it will forward port <code>8080</code> from the container to our <code>8080</code> port and access the <code>http://localhost:8080</code> .</p>
<h3 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a>Conclusions</h3><p>Personally, I will choose the second Dockerfile . Why? because the size is small and it still has several commands and a shell command so we can docker exec into the container and access it. If we use the scratch base image, it will be hard for us to debug our running container because we can’t exec into it.</p>
<p>That’s all for this article about Docker with Go Programming, hope you have a nice day :).</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/42/">42</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lnmput@gmail.com</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
