<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"swoole.app","root":"/","images":"/images","scheme":"Gemini","version":"8.7.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="现在努力的你，未来的事情谁说得清楚呢？ 但你不努力，未来是怎样大概都知道了。   Exceptions are a very important method for controlling the execution flow of an application. When an application request diverges from the happy path, it’s of">
<meta property="og:type" content="article">
<meta property="og:title" content="Laravel异常处理构建">
<meta property="og:url" content="https://swoole.app/2018/06/07/laravel%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9E%84%E5%BB%BA/index.html">
<meta property="og:site_name" content="杨子鳄鱼 ● 外贸自建站">
<meta property="og:description" content="现在努力的你，未来的事情谁说得清楚呢？ 但你不努力，未来是怎样大概都知道了。   Exceptions are a very important method for controlling the execution flow of an application. When an application request diverges from the happy path, it’s of">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2018-06-07T10:46:59.000Z">
<meta property="article:modified_time" content="2018-06-07T12:01:01.000Z">
<meta property="article:author" content="lnmput@gmail.com">
<meta property="article:tag" content="Laravel">
<meta property="article:tag" content="翻译">
<meta property="article:tag" content="translate">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://swoole.app/2018/06/07/laravel%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9E%84%E5%BB%BA/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://swoole.app/2018/06/07/laravel%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9E%84%E5%BB%BA/","path":"2018/06/07/laravel异常处理构建/","title":"Laravel异常处理构建"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Laravel异常处理构建 | 杨子鳄鱼 ● 外贸自建站</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">杨子鳄鱼 ● 外贸自建站</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">十年外贸建站经验，专注外贸独立站建设</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-首页"><a href="/" rel="section">首页</a></li>
        <li class="menu-item menu-item-标签"><a href="/tags" rel="section">标签</a></li>
        <li class="menu-item menu-item-读书"><a href="/read" rel="section">读书</a></li>
        <li class="menu-item menu-item-翻译"><a href="/tags/translate" rel="section">翻译</a></li>
        <li class="menu-item menu-item-关于我"><a href="/about" rel="section">关于我</a></li>
        <li class="menu-item menu-item-外贸站"><a href="/site" rel="section">外贸站</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Understanding-HTTP-Status-Codes"><span class="nav-number">1.</span> <span class="nav-text">Understanding HTTP Status Codes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#How-this-Exception-foundation-will-work"><span class="nav-number">2.</span> <span class="nav-text">How this Exception foundation will work</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-the-Errors-configuration-file"><span class="nav-number">3.</span> <span class="nav-text">Creating the Errors configuration file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-the-abstract-Exception"><span class="nav-number">4.</span> <span class="nav-text">Creating the abstract Exception</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-the-base-Exceptions"><span class="nav-number">5.</span> <span class="nav-text">Creating the base Exceptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Creating-the-application-Exceptions"><span class="nav-number">6.</span> <span class="nav-text">Creating the application Exceptions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Dealing-with-Exceptions-and-returning-the-correct-response"><span class="nav-number">7.</span> <span class="nav-text">Dealing with Exceptions and returning the correct response</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Conclusion"><span class="nav-number">8.</span> <span class="nav-text">Conclusion</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lnmput@gmail.com"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">lnmput@gmail.com</p>
  <div class="site-description" itemprop="description">要么庸俗，要么孤独</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">393</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="http://www.laruence.com/" title="风雪之隅 → http:&#x2F;&#x2F;www.laruence.com&#x2F;" rel="noopener" target="_blank">风雪之隅</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://tech.youzan.com/" title="有赞技术团队 → http:&#x2F;&#x2F;tech.youzan.com&#x2F;" rel="noopener" target="_blank">有赞技术团队</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tech.meituan.com/archives" title="美团点评技术团队 → https:&#x2F;&#x2F;tech.meituan.com&#x2F;archives" rel="noopener" target="_blank">美团点评技术团队</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://macshuo.com/" title="點燈坊 → http:&#x2F;&#x2F;macshuo.com&#x2F;" rel="noopener" target="_blank">點燈坊</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://blog.turn.tw/" title="轉個彎日誌 → http:&#x2F;&#x2F;blog.turn.tw&#x2F;" rel="noopener" target="_blank">轉個彎日誌</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/lnmput" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/07/laravel%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9E%84%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Laravel异常处理构建
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-07 19:46:59 / 修改时间：21:01:01" itemprop="dateCreated datePublished" datetime="2018-06-07T19:46:59+09:00">2018-06-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote class="blockquote-center">
现在努力的你，未来的事情谁说得清楚呢？
但你不努力，未来是怎样大概都知道了。
</blockquote>

<p>Exceptions are a very important method for controlling the execution flow of an application. When an application request diverges from the happy path, it’s often important that you halt execution immediately and take another course of action.</p>
<p>Dealing with problems in an API is especially important. The response from the API is the user interface and so you need to ensure you give a detailed and descriptive explanation of what went wrong.</p>
<p>This includes the HTTP Status code, and error code that is linked to your documentation, as well as a human readable description of what went wrong.</p>
<p>In today’s tutorial I’m going to show you how I structure my Laravel API applications to use Exceptions. This structure will make it very easy to return detailed and descriptive error responses from your API, as well as make testing your code a lot easier.</p>
<p>After a brief hiatus I’m returning to writing about Laravel. After writing about PHP week after week for a long time I was really burned out and needed to take a break.</p>
<p>However, over the last couple of months I’ve been doing some of my best work focusing on Laravel API applications. This has given me a renewed focus with lots of new ideas and techniques I want to share with you.</p>
<p>Instead of starting a new project I’m just going to reboot the existing Cribbb series. All of the code from the previous tutorials can still be found within the Git history.</p>
<h3 id="Understanding-HTTP-Status-Codes"><a href="#Understanding-HTTP-Status-Codes" class="headerlink" title="Understanding HTTP Status Codes"></a>Understanding HTTP Status Codes</h3><p>The first important thing to understand when building an API is that the Internet is built upon standards and protocols. Your API is an “interface” into your application and so it is very important that you adhere to these standards.</p>
<p>When a web service returns a response from a request, it should include a Status Code. The Status Code describes the response, whether the request was successful or if an error has occurred.</p>
<p>For example, when a request is successful, your API should return a Status Code of 200, when the client makes a bad request, you should return a Status Code of 400, and if there is an internal server error, you should return a Status Code of 500.</p>
<p>By sticking to these Status Codes and using them under the correct conditions, we can make our API easier to consume for third-party developers and applications.</p>
<p>If you are unfamiliar with the standard HTTP Status Codes I would recommend bookmarking the Wikipedia page and referring to it often. You will find you only ever really use a small handful of the status codes, but it is a good idea to be familiar with them.</p>
<h3 id="How-this-Exception-foundation-will-work"><a href="#How-this-Exception-foundation-will-work" class="headerlink" title="How this Exception foundation will work"></a>How this Exception foundation will work</h3><p>Whenever we return a response from the API it must use one of the standard HTTP status codes. We must also use the correct status code to describe what happened.</p>
<p>Using the incorrect status code is a really bad thing to do because you are giving the consumer of the API bad information. For example, if you return a 200 Status Code instead of a 400 Status Code, the consumer won’t know they are making an invalid request.</p>
<p>Therefore, we should be able to categorise anything that could possible go wrong in the application as one of the standard HTTP Status Codes.</p>
<p>For example, if the client requests a resource that doesn’t exist we should return a 404 Not Found response.</p>
<p>To trigger this response from our code, we can throw a matching NotFoundException Exception.</p>
<p>To do this we can create base Exception classes for each HTTP status code.</p>
<p>Next, in our application code we can create specific Exceptions that extend the base HTTP Exceptions to provide a more granular understanding of what went wrong. For example, we might have a UserNotFound Exception that extends the NotFoundException base Exception class.</p>
<p>This means under an exceptional circumstance we can throw a specific Exception for that problem and let it bubble up to the surface.</p>
<p>The application will automatically return the correct HTTP response from the base Exception class.</p>
<p>Finally we also need a way of providing a descriptive explanation of what went wrong. We can achieve this by defining error messages that will be injected when the exception class is thrown.</p>
<p>Hopefully that makes sense. But even if it doesn’t, continue reading as I think it will all fall into place as we look at some code.</p>
<h3 id="Creating-the-Errors-configuration-file"><a href="#Creating-the-Errors-configuration-file" class="headerlink" title="Creating the Errors configuration file"></a>Creating the Errors configuration file</h3><p>It’s very important that you provide your API responses with a descriptive explanation of what went wrong.</p>
<p>If you don’t provide details of exactly what went wrong the consumers of your API are going to struggle to fix the issue.</p>
<p>To keep all of the possible error responses in one place I’m going to create an errors.php configuration file under the config directory.</p>
<p>This will mean we have all of the possible errors in one place which will make creating documentation a lot easier.</p>
<p>It should also make it easy to provide language translations for the errors too, rather than trying to dig through the code to find every single error!</p>
<p>To begin with I’ve created some errors for a couple of the standard HTTP error responses:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">|—————————————————————————————————————  </span></span><br><span class="line"><span class="comment">| Default Errors  </span></span><br><span class="line"><span class="comment">|—————————————————————————————————————  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;bad_request&#x27;</span> =&gt; [  </span><br><span class="line"><span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;The server cannot or will not process the request due to something that is perceived to be a client error.&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;detail&#x27;</span> =&gt; <span class="string">&#x27;Your request had an error. Please try again.&#x27;</span>  </span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;forbidden&#x27;</span> =&gt; [  </span><br><span class="line"><span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;The request was a valid request, but the server is refusing to respond to it.&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;detail&#x27;</span> =&gt; <span class="string">&#x27;Your request was valid, but you are not authorised to perform that action.&#x27;</span>  </span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;not_found&#x27;</span> =&gt; [  </span><br><span class="line"><span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;The requested resource could not be found but may be available again in the future. Subsequent requests by the client are permissible.&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;detail&#x27;</span> =&gt; <span class="string">&#x27;The resource you were looking for was not found.&#x27;</span>  </span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;precondition_failed&#x27;</span> =&gt; [  </span><br><span class="line"><span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;The server does not meet one of the preconditions that the requester put on the request.&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;detail&#x27;</span> =&gt; <span class="string">&#x27;Your request did not satisfy the required preconditions.&#x27;</span>  </span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">];  </span><br></pre></td></tr></table></figure>
<p>As the application is developed I can add to this list. It’s also often a good idea to provide a link to the relevant documentation page. At some point in the future I can simply add this into each error.</p>
<h3 id="Creating-the-abstract-Exception"><a href="#Creating-the-abstract-Exception" class="headerlink" title="Creating the abstract Exception"></a>Creating the abstract Exception</h3><p>Next I want to create an abstract Exception class that all of my application specific exceptions will extend from.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">Cribbb</span>\<span class="title">Exceptions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CribbbException</span> <span class="keyword">extends</span> <span class="title">Exception</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$status</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$title</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$detail</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> <span class="doctag">@string</span> $message  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> void  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$message</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="built_in">parent</span>::__construct(<span class="variable">$message</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>This will make it easy to catch all of the application specific exceptions and provides a clean separation from the other potential exceptions that may be thrown during the application’s execution.</p>
<p>For each exception I will provide an id, status, title and detail.</p>
<p>This is to stay close to the JSON API specification.</p>
<p>I will also provide a getStatus method</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Get the status  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> int  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getStatus</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">int</span>) <span class="keyword">$this</span>-&gt;status;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>The JSON API specification states that the status code should be a string. I’m casting it as an int in this method so I can provide the correct response code to Laravel.</p>
<p>I will also provide a toArray() method to return the Exception as an array. This is just for convenience:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Return the Exception as an array  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> array  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line"><span class="keyword">return</span> [  </span><br><span class="line">	<span class="string">&#x27;id&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;id,  </span><br><span class="line">	<span class="string">&#x27;status&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;status,  </span><br><span class="line">	<span class="string">&#x27;title&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;title,  </span><br><span class="line">	<span class="string">&#x27;detail&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;detail  </span><br><span class="line">	];  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>Finally I need to get the title and detail for each specific error from the errors.php file.</p>
<p>To do this I will accept the exception id when a new Exception is instantiated.</p>
<p>I will then use this id to get the title and detail from the errors.php file.</p>
<p>So throwing an Exception will look like this:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> UserNotFound(<span class="string">&#x27;user_not_found&#x27;</span>);  </span><br></pre></td></tr></table></figure>

<p>However, I will also want to provide specific details of the Exception under certain circumstances.</p>
<p>For example I might want to provide the user’s id in the exception detail.</p>
<p>To do this I will allow the exception to accept an arbitrary number of arguments:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> UserNotFound(<span class="string">&#x27;user_not_found&#x27;</span>, <span class="variable">$id</span>);  </span><br></pre></td></tr></table></figure>

<p>To set up the Exception with the correct message I will use the following method:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Build the Exception  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> array $args  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$args</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="keyword">$this</span>-&gt;id = array_shift(<span class="variable">$args</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$error</span> = config(sprintf(<span class="string">&#x27;errors.%s&#x27;</span>, <span class="keyword">$this</span>-&gt;id));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">$this</span>-&gt;title = <span class="variable">$error</span>[<span class="string">&#x27;title&#x27;</span>];  </span><br><span class="line">	<span class="keyword">$this</span>-&gt;detail = vsprintf(<span class="variable">$error</span>[<span class="string">&#x27;detail&#x27;</span>], <span class="variable">$args</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;detail;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>In this method I first pop off the first argument as this will be the id.</p>
<p>Next I get the title and detail from the errors.php configuration file using the id.</p>
<p>Next I vsprintf the remaining arguments into the detail string if they have been passed into the exception.</p>
<p>Finally I can return the detail to be used as the default Exception message.</p>
<h3 id="Creating-the-base-Exceptions"><a href="#Creating-the-base-Exceptions" class="headerlink" title="Creating the base Exceptions"></a>Creating the base Exceptions</h3><p>With the abstract Exception in place I can now create the base Exceptions.</p>
<p>For example, here is the NotFoundException</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">Cribbb</span>\<span class="title">Exceptions</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFoundException</span> <span class="keyword">extends</span> <span class="title">CribbbException</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$status</span> = <span class="string">&#x27;404’;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/**  </span></span><br><span class="line"><span class="string">* @return void  </span></span><br><span class="line"><span class="string">*/  </span></span><br><span class="line"><span class="string">public function __construct()  </span></span><br><span class="line"><span class="string">&#123;  </span></span><br><span class="line"><span class="string">$message = $this-&gt;build(func_get_args());</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">parent::__construct($message);  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br></pre></td></tr></table></figure>
<p>Each base foundation Exception simply needs to provide the status code and a call to the __construct() method that will call the build() method and pass the message to the parent.</p>
<p>You can now create these simple Exception classes to represent each HTTP status code your application will be using.</p>
<p>If you need to add a new HTTP status code response, it’s very easy to just create a new child class.</p>
<h3 id="Creating-the-application-Exceptions"><a href="#Creating-the-application-Exceptions" class="headerlink" title="Creating the application Exceptions"></a>Creating the application Exceptions</h3><p>Finally we can use these base HTTP Exceptions within our application code to provide more specific Exceptions.</p>
<p>For example you might have a UserNotFound Exception:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">Cribbb</span>\<span class="title">Users</span>\<span class="title">Exceptions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Cribbb</span>\<span class="title">Exceptions</span>\<span class="title">NotFoundException</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserNotFound</span> <span class="keyword">extends</span> <span class="title">NotFoundException</span>  </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>Now whenever you attempt to find a user, but the user is not found you can throw this Exception.</p>
<p>The Exception will bubble up to the surface and the correct HTTP Response will be automatically returned with an appropriate error message.</p>
<p>This means if an Exception is throw, you can just let it go, you don’t have to catch it because the consumer needs to be informed that the user was not found.</p>
<p>And in your tests you can assert a UserNotFound exception was thrown, rather than just a generic NotFound exception. This means you can write tests where you are confident the test is failing for the correct reason. This makes reading your tests very easy to understand.</p>
<h3 id="Dealing-with-Exceptions-and-returning-the-correct-response"><a href="#Dealing-with-Exceptions-and-returning-the-correct-response" class="headerlink" title="Dealing with Exceptions and returning the correct response"></a>Dealing with Exceptions and returning the correct response</h3><p>Laravel allows you to handle Exceptions and return a response in the Handler.php file under the Exceptions namespace.</p>
<p>The first thing I’m going to do is to add the base CribbbException class to the $dontReport array.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* A list of the exception types that should not be reported  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> array  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$dontReport</span> = [  </span><br><span class="line">	HttpException::class,  </span><br><span class="line">	CribbbException::class  </span><br><span class="line">];  </span><br></pre></td></tr></table></figure>

<p>I don’t need to be told that an application specific Exception has been thrown because this is to be expected. By extending from the base CribbbException class we’ve made it very easy to capture all of the application specific exceptions.</p>
<p>Next I’m going to update the render() method to only render the Exception if we’ve got the app.debug config setting to true, otherwise we can deal with the Exception in the handle() method:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Render an exception into an HTTP response  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> Request $request  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> Exception $e  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> Response  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Exception</span> <span class="variable">$e</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (config(<span class="string">&#x27;app.debug&#x27;</span>)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parent</span>::render(<span class="variable">$request</span>, <span class="variable">$e</span>);  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handle(<span class="variable">$request</span>, <span class="variable">$e</span>);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>And finally we can convert the Exception into a JsonResponse in the handle() method:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Convert the Exception into a JSON HTTP Response  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> Request $request  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> Exception $e  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> JSONResponse  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Exception</span> <span class="variable">$e</span></span>) </span>&#123;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$e</span> <span class="keyword">instanceOf</span> CribbbException) &#123;  </span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$e</span>-&gt;toArray();  </span><br><span class="line"><span class="variable">$status</span> = <span class="variable">$e</span>-&gt;getStatus();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$e</span> <span class="keyword">instanceOf</span> NotFoundHttpException) &#123;  </span><br><span class="line"><span class="variable">$data</span> = array_merge([  </span><br><span class="line"><span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;not_found&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;status&#x27;</span> =&gt; <span class="string">&#x27;404&#x27;</span>  </span><br><span class="line">], config(<span class="string">&#x27;errors.not_found&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$status</span> = <span class="number">404</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$e</span> <span class="keyword">instanceOf</span> MethodNotAllowedHttpException) &#123;  </span><br><span class="line"><span class="variable">$data</span> = array_merge([  </span><br><span class="line"><span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;method_not_allowed&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;status&#x27;</span> =&gt; <span class="string">&#x27;405&#x27;</span>  </span><br><span class="line">], config(<span class="string">&#x27;errors.method_not_allowed&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$status</span> = <span class="number">405</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> response()-&gt;json(<span class="variable">$data</span>, <span class="variable">$status</span>);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>For the CribbbException classes we can simply call the toArray() method to return the Exception into an array as well as the getStatus() method to return the HTTP Status Code.</p>
<p>We can also deal with any other Exception classes in this method. As you can see I’m catching the NotFoundHttpException and MethodNotAllowedHttpException Exceptions in this example so I can return the correct response.</p>
<p>Finally we can return a JsonResponse by using the json() method on the response() helper function method with the $data and $status included.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>Exceptions are a very important aspect of application development and they are an excellent tool in controlling the execution flow of the application.</p>
<p>Under exceptional circumstances you need to halt the application and return an error rather than continuing on with execution. Exceptions make this very easy to achieve.</p>
<p>It’s important that an API always returns the correct HTTP status code. The API is the interface to your application and so it is very important that you follow the recognised standards and protocols.</p>
<p>You also need to return a human readable error message as well as provide up-to-date documentation of the problem and how it can be resolved.</p>
<p>In today’s tutorial we’ve created a foundation for using Exceptions in the application by creating base classes for each HTTP status code.</p>
<p>Whenever a problem arrises in the application we have no reason not to return the specific HTTP status code for that problem.</p>
<p>We’ve also put in place an easy way to list detailed error messages for every possible thing that could go wrong.</p>
<p>This will be easy to keep up-to-date because it’s all in one place.</p>
<p>And finally we’ve created an easy way to use Exceptions in the application. By extending these base Exceptions with application specific exceptions we can create a very granular layer of Exceptions within our application code.</p>
<p>This make it very easy to write tests where you can assert that the correct Exception is being thrown under the specific circumstances.</p>
<p>And it also make it really easy to deal with exceptions because 9 times out of 10 you can just let the exception bubble up to the surface.</p>
<p>When the exception reaches the surface, the correct HTTP status code and error message will automatically be returned to the client.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Laravel/" rel="tag"># Laravel</a>
              <a href="/tags/%E7%BF%BB%E8%AF%91/" rel="tag"># 翻译</a>
              <a href="/tags/translate/" rel="tag"># translate</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2018/06/04/nginx%E4%BD%BF%E7%94%A8lua-redis%E9%99%90%E5%88%B6ip%E7%9A%84%E8%AE%BF%E9%97%AE%E9%A2%91%E7%8E%87/" rel="prev" title="Nginx使用Lua+Redis限制IP的访问频率">
                  <i class="fa fa-chevron-left"></i> Nginx使用Lua+Redis限制IP的访问频率
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2018/06/14/%E5%9C%A8laravel%E4%B8%AD%E4%BD%BF%E7%94%A8redis/" rel="next" title="在laravel中使用redis">
                  在laravel中使用redis <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lnmput@gmail.com</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
