<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico">
  <link rel="mask-icon" href="/favicon.ico" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"swoole.app","root":"/","images":"/images","scheme":"Gemini","version":"8.7.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="要么庸俗，要么孤独">
<meta property="og:type" content="website">
<meta property="og:title" content="杨子鳄鱼 ● 外贸自建站">
<meta property="og:url" content="https://swoole.app/page/13/index.html">
<meta property="og:site_name" content="杨子鳄鱼 ● 外贸自建站">
<meta property="og:description" content="要么庸俗，要么孤独">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="lnmput@gmail.com">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://swoole.app/page/13/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/13/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>杨子鳄鱼 ● 外贸自建站</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">杨子鳄鱼 ● 外贸自建站</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">专注外贸独立站建设</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-首页"><a href="/" rel="section">首页</a></li>
        <li class="menu-item menu-item-标签"><a href="/tags" rel="section">标签</a></li>
        <li class="menu-item menu-item-读书"><a href="/read" rel="section">读书</a></li>
        <li class="menu-item menu-item-翻译"><a href="/tags/translate" rel="section">翻译</a></li>
        <li class="menu-item menu-item-关于我"><a href="/about" rel="section">关于我</a></li>
        <li class="menu-item menu-item-外贸站"><a href="/site" rel="section">外贸站</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="lnmput@gmail.com"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">lnmput@gmail.com</p>
  <div class="site-description" itemprop="description">要么庸俗，要么孤独</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">408</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">134</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="http://www.laruence.com/" title="风雪之隅 → http:&#x2F;&#x2F;www.laruence.com&#x2F;" rel="noopener" target="_blank">风雪之隅</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://tech.youzan.com/" title="有赞技术团队 → http:&#x2F;&#x2F;tech.youzan.com&#x2F;" rel="noopener" target="_blank">有赞技术团队</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://tech.meituan.com/archives" title="美团点评技术团队 → https:&#x2F;&#x2F;tech.meituan.com&#x2F;archives" rel="noopener" target="_blank">美团点评技术团队</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://macshuo.com/" title="點燈坊 → http:&#x2F;&#x2F;macshuo.com&#x2F;" rel="noopener" target="_blank">點燈坊</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://blog.turn.tw/" title="轉個彎日誌 → http:&#x2F;&#x2F;blog.turn.tw&#x2F;" rel="noopener" target="_blank">轉個彎日誌</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/lnmput" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/14/laravel%E4%B8%AD%E4%BD%BF%E7%94%A8redis%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/14/laravel%E4%B8%AD%E4%BD%BF%E7%94%A8redis%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4/" class="post-title-link" itemprop="url">laravel中使用redis基本命令</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-14 14:37:25 / 修改时间：15:56:46" itemprop="dateCreated datePublished" datetime="2018-06-14T14:37:25+09:00">2018-06-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
The wealth of the mind is the only wealth.
</blockquote>

<p>Let’s store our product sales in a key:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Redis::set(<span class="string">&#x27;product:1:sales&#x27;</span>, <span class="number">1000</span>)</span><br><span class="line">Redis::set(<span class="string">&#x27;product:1:count&#x27;</span>, <span class="number">10</span>)</span><br></pre></td></tr></table></figure>
<p>Now to read it we use:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::get(<span class="string">&#x27;product:1:sales&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Incrementing-and-Decrementing-counters"><a href="#Incrementing-and-Decrementing-counters" class="headerlink" title="Incrementing and Decrementing counters"></a>Incrementing and Decrementing counters</h3><p>A new purchase was made, let’s increment the sales:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Redis::incrby(<span class="string">&#x27;product:1:sales&#x27;</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">Redis::incr(<span class="string">&#x27;product:1:count&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Here we increment the sales key by 100, and increment the count key by 1.</p>
<p>We can also decrement in the same way:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Redis::decrby(<span class="string">&#x27;product:1:sales&#x27;</span>, <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">Redis::decr(<span class="string">&#x27;product:1:count&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>But when it comes to dealing with floating point numbers we need to use a special command:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Redis::incrbyfloat(<span class="string">&#x27;product:1:sales&#x27;</span>, <span class="number">15.5</span>)</span><br><span class="line"></span><br><span class="line">Redis::incrbyfloat(<span class="string">&#x27;product:1:sales&#x27;</span>, - <span class="number">30.2</span>)</span><br></pre></td></tr></table></figure>
<p>There’s no decrbyfloat command, but we can pass a negative value to the incrbyfloat command to have the same effect.</p>
<blockquote>
<p>The incrby, incr, decrby, decr, and incrbyfloat return the value after the operation as a response</p>
</blockquote>
<h3 id="Retrieve-and-update"><a href="#Retrieve-and-update" class="headerlink" title="Retrieve and update"></a>Retrieve and update</h3><p>Now we want to read the latest sales number and reset the counters to zero, maybe we do that at the end of each day:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$value</span> = Redis::getset(<span class="string">&#x27;product:1:sales&#x27;</span>, <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>Here $value will hold the 1000 value, if we read the value of that key after this operation it’ll be 0.</p>
<h3 id="Keys-Expiration"><a href="#Keys-Expiration" class="headerlink" title="Keys Expiration"></a>Keys Expiration</h3><p>Let’s say we want to send a notification to the owner when inventory is low, but we only want to send that notification once every 1 hour instead of sending it every time a new purchase is made, so maybe we set a flag once and only send the notification when that flag doesn’t exist:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::set(<span class="string">&#x27;user:1:notified&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;EX&#x27;</span>, <span class="number">3600</span>);</span><br></pre></td></tr></table></figure>
<p>Now this key will expire after 3600 seconds (1 hour), we can check if the key exists before attempting to set it and send the notification:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(Redis::get(<span class="string">&#x27;user:1:notified&#x27;</span>))&#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Redis::set(<span class="string">&#x27;user:1:notified&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;EX&#x27;</span>, <span class="number">3600</span>);</span><br><span class="line"></span><br><span class="line">Notifications::send();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Notice: There’s no guarantee that the value of user:1:notified won’t change between the get and set operations, we’ll discuss atomic command groups later, but this example is enough for you to understand how every individual command works.</p>
</blockquote>
<p>We can set the expiration of a key in milliseconds as well using:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::set(<span class="string">&#x27;user:1:notified&#x27;</span>, <span class="number">1</span>, <span class="string">&#x27;PX&#x27;</span>, <span class="number">3600</span>);</span><br></pre></td></tr></table></figure>
<p>And you may also use the expire command and provide the timeout in seconds:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::expire(<span class="string">&#x27;user:1:notified&#x27;</span>, <span class="number">3600</span>);</span><br></pre></td></tr></table></figure>
<p>Or in milliseconds:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::pexpire(<span class="string">&#x27;user:1:notified&#x27;</span>, <span class="number">3600</span>);</span><br></pre></td></tr></table></figure>
<p>And if you want the keys to expire at a specific time you can use expireat and provide a Unix timestamp:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::expireat(<span class="string">&#x27;user:1:notified&#x27;</span>, <span class="string">&#x27;1495469730&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>Is there a way I can check when a key should expire?<br>You can use the ttl command (Time To Live), which will return the number of seconds remaining until the key expires.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::ttl(<span class="string">&#x27;user:1:notified&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>That command may return -2 if the key doesn’t exist, or -1 if the key has no expiration set.</p>
<p>You can also use the pttl command to get the TTL in milliseconds.</p>
<p>What if I want to cancel expiration?</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::persist(<span class="string">&#x27;user:1:notified&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>This will remove the expiration from your key, it’ll return 1 if OK or 0 if key doesn’t exist or originally had no expiration set.</p>
<h3 id="Keys-Existence"><a href="#Keys-Existence" class="headerlink" title="Keys Existence"></a>Keys Existence</h3><p>Let’s say there’s only 1 laracon ticket available and we need to close purchasing once that ticket is sold, we can do:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::set(<span class="string">&#x27;ticket:sold&#x27;</span>, <span class="variable">$user</span>-&gt;id, <span class="string">&#x27;NX&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>This will only set the key if it doesn’t exist, the next script that tries to set the key wll receive null as a response from Redis which means that the key wasn’t set.</p>
<p>You can also instruct Redis to set the key only if it exists:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::set(<span class="string">&#x27;ticket:sold&#x27;</span>, <span class="variable">$user</span>-&gt;id, <span class="string">&#x27;XX&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>If you want to simply check if a key exists, you can use the exists command:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::exists(<span class="string">&#x27;ticket:sold&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="Reading-multiple-keys-in-one-go"><a href="#Reading-multiple-keys-in-one-go" class="headerlink" title="Reading multiple keys in one go"></a>Reading multiple keys in one go</h3><p>Sometimes you might need to read multiple keys in one go, you can do this:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::mget(<span class="string">&#x27;product:1:sales&#x27;</span>, <span class="string">&#x27;product:2:sales&#x27;</span>, <span class="string">&#x27;non_existing_key&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>The response of this command is an array with the same size of the given keys, if a key doesn’t exist its value is going to be null.</p>
<p>As we discussed before, Redis executes individual command atomically, that means nothing can change the value of any in the keys once the operation started, so it’s guaranteed that the values returned are not altered in between reading the value of the first key and the last key.</p>
<blockquote>
<p>Using mget is better that firing multiple get commands to reduce the RTT (round trip time), which is the time each individual command takes to travel from client to the server and then carry the response back to the client. More on that later.</p>
</blockquote>
<h3 id="Deleting-Keys"><a href="#Deleting-Keys" class="headerlink" title="Deleting Keys"></a>Deleting Keys</h3><p>You can also delete multiple keys at once using the del command:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::del(<span class="string">&#x27;previous:sales&#x27;</span>, <span class="string">&#x27;previous:return&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Renaming-Keys"><a href="#Renaming-Keys" class="headerlink" title="Renaming Keys"></a>Renaming Keys</h3><p>You can rename a key using the rename command:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::rename(<span class="string">&#x27;current:sales&#x27;</span>, <span class="string">&#x27;previous:sales&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>An error is returned if the original key doesn’t exist, and it overrides the second key if it already exists.</p>
<p>Renaming keys is usually a fast operation unless a key with the desired name exists, in that case Redis will try to delete that existing key first before renaming this one, deleting a key that holds a very big value might be a bit slow.</p>
<p>So I have to check first if the second key exists to prevent overriding?<br>Yeah you can use exists to check if the second key exists… OR:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Redis::renamenx(<span class="string">&#x27;current:sales&#x27;</span>, <span class="string">&#x27;previous:sales&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>This will check first if the second key exists, if yes it just returns 0 without doing anything, so it only renames the key if the second key does not exist.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://divinglaravel.com/redis/redis-commands">https://divinglaravel.com/redis/redis-commands</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/14/%E5%9C%A8laravel%E4%B8%AD%E4%BD%BF%E7%94%A8redis/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/14/%E5%9C%A8laravel%E4%B8%AD%E4%BD%BF%E7%94%A8redis/" class="post-title-link" itemprop="url">在laravel中使用redis</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-14 14:31:18 / 修改时间：15:57:18" itemprop="dateCreated datePublished" datetime="2018-06-14T14:31:18+09:00">2018-06-14</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
Honesty is the best policy.
</blockquote>

<p>Redis is a storage server that persists your data in memory which makes read &amp; write operations very fast, you can also configure it to store the data on disk occasionally, replicate to secondary nodes, and automatically split the data across multiple nodes.</p>
<p>That said, you might want to use Redis when fast access to your data is necessary (caching, live analytics, queue system, etc…), however you’ll need another data storage for when the data is too large to fit in memory or you don’t really need to have fast access, so a combination of Redis &amp; another relational or non-relational database gives you the power to build large scale applications where you can efficiently store large data but also provide a way to read portions of the data very fast.</p>
<h3 id="Use-Case"><a href="#Use-Case" class="headerlink" title="Use Case"></a>Use Case</h3><p>Think of a cloud-based Point Of Sale application for restaurants, as owner it’s extremely important to be able to monitor different statistics related to sales, inventory, performance of different branches, and many other metrics. Let’s focus on one particular metric which is Product Sales, as a developer you want to build a dashboard where the restaurant owner can see live updates on what products have more sales throughout the day.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select SUM(order_products.price), products.name</span><br><span class="line"><span class="keyword">from</span> order_products</span><br><span class="line">join products on order_products.product_id = products.id</span><br><span class="line">where DATE(order_products.created_at) = CURDATE()</span><br><span class="line">where order_products.status = <span class="string">&quot;done&quot;</span></span><br></pre></td></tr></table></figure>
<p>The sql query above will bring you a list with the sales each product made throughout the day, but it’s a relatively heavy query to run when the restaurant serves thousands of orders every day, simply put you can’t run this query in a live-updates dashboard that pulls for updates every 60 seconds or something, it’d be cool if you can cache the product sales every time an order is served and be able to read from the cache, something like:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Event::listen(<span class="string">&#x27;newOrder&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$order</span></span>) </span>&#123;</span><br><span class="line">    <span class="variable">$order</span>-&gt;products-&gt;each(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$product</span></span>)</span>&#123;</span><br><span class="line">        SomeStorage::increment(<span class="string">&quot;product:<span class="subst">&#123;$product-&gt;id&#125;</span>:sales:2017-05-22&quot;</span>, <span class="variable">$product</span>-&gt;sales);</span><br><span class="line">    );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>So now on every new order we’ll increment the sales for each product, and we can simply read these numbers later like:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$sales</span> = Product::all()-&gt;map(<span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$product</span></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> SomeStorage::get(<span class="string">&quot;product:<span class="subst">&#123;$product-&gt;id&#125;</span>:sales:2017-05-22&quot;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>Replace SomeStorage with Redis and now you have today’s product sales living in your server’s memory, and it’s super fast to read from memory, so you don’t have to run that large query every time you need to update the analytics numbers in the live dashboard.</p>
<h3 id="Another-Use-Case"><a href="#Another-Use-Case" class="headerlink" title="Another Use Case"></a>Another Use Case</h3><p>Now you want to know the number of unique visitors opening your website every day, we might store it in SQL having a table with user_id &amp; date fields, and later on we can just run a query like:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select COUNT(Distinct user_id) <span class="keyword">as</span> count <span class="keyword">from</span> unique_visits where date = <span class="string">&quot;2017-05-22&quot;</span></span><br></pre></td></tr></table></figure>

<p>So we just have to add a record in that database table every time a user visits the site. But still on a high traffic website adding this extra DB interaction might not be the best idea, wouldn’t it be cool if we can just do:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SomeStorage::addUnique(<span class="string">&#x27;unique_visits:2017-05-22&#x27;</span>, <span class="variable">$user</span>-&gt;id);</span><br></pre></td></tr></table></figure>
<p>And later on we can do:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SomeStorage::count(<span class="string">&#x27;unique_visits:2017-05-22&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>Storing this in memory is fast and reading the stored numbers from memory is super fast, that’s exactly what we need, so I hope by now you got a feel on when using Redis might be a good idea. And by the way the method names used in the above examples don’t exist in redis, I’m just trying to give you a feel about what you can achieve.</p>
<h3 id="The-Atomic-nature-of-redis-operations"><a href="#The-Atomic-nature-of-redis-operations" class="headerlink" title="The Atomic nature of redis operations"></a>The Atomic nature of redis operations</h3><p>Individual commands in Redis are guaranteed to be atomic, that means nothing will change while executing a command, for example:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$monthSales</span> = Redis::getSet(<span class="string">&#x27;monthSales&#x27;</span>, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>This command gets the value of the monthSales key and then sets it to zero, it’s guaranteed that no other client can change the value or maybe rename the key between the get and set operations, that’s due to the single threaded nature of Redis in which a single system process serves all clients at the same time but can only perform 1 operation at a time, it’s similar to how you can listen to multiple client alterations on the project at the same time but can only work on 1 alteration at a given moment.</p>
<p>There’s also a way to guarantee the atomicity of a group of commands using transactions, more on that later, but briefly let’s say you have 2 clients:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Client <span class="number">1</span> wants to increment the value</span><br><span class="line">Client <span class="number">1</span> wants to read that value</span><br><span class="line">Client <span class="number">2</span> wants to increment the value</span><br></pre></td></tr></table></figure>

<p>These commands might run in the following order:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Client <span class="number">1</span>: Increment value</span><br><span class="line">Client <span class="number">2</span>: Increment value</span><br><span class="line">Client <span class="number">1</span>: read value</span><br></pre></td></tr></table></figure>

<p>Which will result the read operation from Client 1 to give unexpected results since the value was altered in the middle, that’s when a transaction makes sense.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://divinglaravel.com/redis/before-the-dive">https://divinglaravel.com/redis/before-the-dive</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/07/laravel%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9E%84%E5%BB%BA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/07/laravel%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E6%9E%84%E5%BB%BA/" class="post-title-link" itemprop="url">Laravel异常处理构建</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-07 19:46:59 / 修改时间：21:01:01" itemprop="dateCreated datePublished" datetime="2018-06-07T19:46:59+09:00">2018-06-07</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
现在努力的你，未来的事情谁说得清楚呢？
但你不努力，未来是怎样大概都知道了。
</blockquote>

<p>Exceptions are a very important method for controlling the execution flow of an application. When an application request diverges from the happy path, it’s often important that you halt execution immediately and take another course of action.</p>
<p>Dealing with problems in an API is especially important. The response from the API is the user interface and so you need to ensure you give a detailed and descriptive explanation of what went wrong.</p>
<p>This includes the HTTP Status code, and error code that is linked to your documentation, as well as a human readable description of what went wrong.</p>
<p>In today’s tutorial I’m going to show you how I structure my Laravel API applications to use Exceptions. This structure will make it very easy to return detailed and descriptive error responses from your API, as well as make testing your code a lot easier.</p>
<p>After a brief hiatus I’m returning to writing about Laravel. After writing about PHP week after week for a long time I was really burned out and needed to take a break.</p>
<p>However, over the last couple of months I’ve been doing some of my best work focusing on Laravel API applications. This has given me a renewed focus with lots of new ideas and techniques I want to share with you.</p>
<p>Instead of starting a new project I’m just going to reboot the existing Cribbb series. All of the code from the previous tutorials can still be found within the Git history.</p>
<h3 id="Understanding-HTTP-Status-Codes"><a href="#Understanding-HTTP-Status-Codes" class="headerlink" title="Understanding HTTP Status Codes"></a>Understanding HTTP Status Codes</h3><p>The first important thing to understand when building an API is that the Internet is built upon standards and protocols. Your API is an “interface” into your application and so it is very important that you adhere to these standards.</p>
<p>When a web service returns a response from a request, it should include a Status Code. The Status Code describes the response, whether the request was successful or if an error has occurred.</p>
<p>For example, when a request is successful, your API should return a Status Code of 200, when the client makes a bad request, you should return a Status Code of 400, and if there is an internal server error, you should return a Status Code of 500.</p>
<p>By sticking to these Status Codes and using them under the correct conditions, we can make our API easier to consume for third-party developers and applications.</p>
<p>If you are unfamiliar with the standard HTTP Status Codes I would recommend bookmarking the Wikipedia page and referring to it often. You will find you only ever really use a small handful of the status codes, but it is a good idea to be familiar with them.</p>
<h3 id="How-this-Exception-foundation-will-work"><a href="#How-this-Exception-foundation-will-work" class="headerlink" title="How this Exception foundation will work"></a>How this Exception foundation will work</h3><p>Whenever we return a response from the API it must use one of the standard HTTP status codes. We must also use the correct status code to describe what happened.</p>
<p>Using the incorrect status code is a really bad thing to do because you are giving the consumer of the API bad information. For example, if you return a 200 Status Code instead of a 400 Status Code, the consumer won’t know they are making an invalid request.</p>
<p>Therefore, we should be able to categorise anything that could possible go wrong in the application as one of the standard HTTP Status Codes.</p>
<p>For example, if the client requests a resource that doesn’t exist we should return a 404 Not Found response.</p>
<p>To trigger this response from our code, we can throw a matching NotFoundException Exception.</p>
<p>To do this we can create base Exception classes for each HTTP status code.</p>
<p>Next, in our application code we can create specific Exceptions that extend the base HTTP Exceptions to provide a more granular understanding of what went wrong. For example, we might have a UserNotFound Exception that extends the NotFoundException base Exception class.</p>
<p>This means under an exceptional circumstance we can throw a specific Exception for that problem and let it bubble up to the surface.</p>
<p>The application will automatically return the correct HTTP response from the base Exception class.</p>
<p>Finally we also need a way of providing a descriptive explanation of what went wrong. We can achieve this by defining error messages that will be injected when the exception class is thrown.</p>
<p>Hopefully that makes sense. But even if it doesn’t, continue reading as I think it will all fall into place as we look at some code.</p>
<h3 id="Creating-the-Errors-configuration-file"><a href="#Creating-the-Errors-configuration-file" class="headerlink" title="Creating the Errors configuration file"></a>Creating the Errors configuration file</h3><p>It’s very important that you provide your API responses with a descriptive explanation of what went wrong.</p>
<p>If you don’t provide details of exactly what went wrong the consumers of your API are going to struggle to fix the issue.</p>
<p>To keep all of the possible error responses in one place I’m going to create an errors.php configuration file under the config directory.</p>
<p>This will mean we have all of the possible errors in one place which will make creating documentation a lot easier.</p>
<p>It should also make it easy to provide language translations for the errors too, rather than trying to dig through the code to find every single error!</p>
<p>To begin with I’ve created some errors for a couple of the standard HTTP error responses:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> [</span><br><span class="line"></span><br><span class="line"><span class="comment">/*  </span></span><br><span class="line"><span class="comment">|—————————————————————————————————————  </span></span><br><span class="line"><span class="comment">| Default Errors  </span></span><br><span class="line"><span class="comment">|—————————————————————————————————————  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;bad_request&#x27;</span> =&gt; [  </span><br><span class="line"><span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;The server cannot or will not process the request due to something that is perceived to be a client error.&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;detail&#x27;</span> =&gt; <span class="string">&#x27;Your request had an error. Please try again.&#x27;</span>  </span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;forbidden&#x27;</span> =&gt; [  </span><br><span class="line"><span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;The request was a valid request, but the server is refusing to respond to it.&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;detail&#x27;</span> =&gt; <span class="string">&#x27;Your request was valid, but you are not authorised to perform that action.&#x27;</span>  </span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;not_found&#x27;</span> =&gt; [  </span><br><span class="line"><span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;The requested resource could not be found but may be available again in the future. Subsequent requests by the client are permissible.&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;detail&#x27;</span> =&gt; <span class="string">&#x27;The resource you were looking for was not found.&#x27;</span>  </span><br><span class="line">],</span><br><span class="line"></span><br><span class="line"><span class="string">&#x27;precondition_failed&#x27;</span> =&gt; [  </span><br><span class="line"><span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;The server does not meet one of the preconditions that the requester put on the request.&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;detail&#x27;</span> =&gt; <span class="string">&#x27;Your request did not satisfy the required preconditions.&#x27;</span>  </span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">];  </span><br></pre></td></tr></table></figure>
<p>As the application is developed I can add to this list. It’s also often a good idea to provide a link to the relevant documentation page. At some point in the future I can simply add this into each error.</p>
<h3 id="Creating-the-abstract-Exception"><a href="#Creating-the-abstract-Exception" class="headerlink" title="Creating the abstract Exception"></a>Creating the abstract Exception</h3><p>Next I want to create an abstract Exception class that all of my application specific exceptions will extend from.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">Cribbb</span>\<span class="title">Exceptions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Exception</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">CribbbException</span> <span class="keyword">extends</span> <span class="title">Exception</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$id</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$status</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$title</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$detail</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> <span class="doctag">@string</span> $message  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> void  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$message</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="built_in">parent</span>::__construct(<span class="variable">$message</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>This will make it easy to catch all of the application specific exceptions and provides a clean separation from the other potential exceptions that may be thrown during the application’s execution.</p>
<p>For each exception I will provide an id, status, title and detail.</p>
<p>This is to stay close to the JSON API specification.</p>
<p>I will also provide a getStatus method</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Get the status  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> int  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getStatus</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">int</span>) <span class="keyword">$this</span>-&gt;status;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>The JSON API specification states that the status code should be a string. I’m casting it as an int in this method so I can provide the correct response code to Laravel.</p>
<p>I will also provide a toArray() method to return the Exception as an array. This is just for convenience:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Return the Exception as an array  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> array  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">toArray</span>(<span class="params"></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line"><span class="keyword">return</span> [  </span><br><span class="line">	<span class="string">&#x27;id&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;id,  </span><br><span class="line">	<span class="string">&#x27;status&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;status,  </span><br><span class="line">	<span class="string">&#x27;title&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;title,  </span><br><span class="line">	<span class="string">&#x27;detail&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;detail  </span><br><span class="line">	];  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>Finally I need to get the title and detail for each specific error from the errors.php file.</p>
<p>To do this I will accept the exception id when a new Exception is instantiated.</p>
<p>I will then use this id to get the title and detail from the errors.php file.</p>
<p>So throwing an Exception will look like this:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> UserNotFound(<span class="string">&#x27;user_not_found&#x27;</span>);  </span><br></pre></td></tr></table></figure>

<p>However, I will also want to provide specific details of the Exception under certain circumstances.</p>
<p>For example I might want to provide the user’s id in the exception detail.</p>
<p>To do this I will allow the exception to accept an arbitrary number of arguments:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> UserNotFound(<span class="string">&#x27;user_not_found&#x27;</span>, <span class="variable">$id</span>);  </span><br></pre></td></tr></table></figure>

<p>To set up the Exception with the correct message I will use the following method:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Build the Exception  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> array $args  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">build</span>(<span class="params"><span class="keyword">array</span> <span class="variable">$args</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">	<span class="keyword">$this</span>-&gt;id = array_shift(<span class="variable">$args</span>);</span><br><span class="line"></span><br><span class="line">	<span class="variable">$error</span> = config(sprintf(<span class="string">&#x27;errors.%s&#x27;</span>, <span class="keyword">$this</span>-&gt;id));</span><br><span class="line"></span><br><span class="line">	<span class="keyword">$this</span>-&gt;title = <span class="variable">$error</span>[<span class="string">&#x27;title&#x27;</span>];  </span><br><span class="line">	<span class="keyword">$this</span>-&gt;detail = vsprintf(<span class="variable">$error</span>[<span class="string">&#x27;detail&#x27;</span>], <span class="variable">$args</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">$this</span>-&gt;detail;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>In this method I first pop off the first argument as this will be the id.</p>
<p>Next I get the title and detail from the errors.php configuration file using the id.</p>
<p>Next I vsprintf the remaining arguments into the detail string if they have been passed into the exception.</p>
<p>Finally I can return the detail to be used as the default Exception message.</p>
<h3 id="Creating-the-base-Exceptions"><a href="#Creating-the-base-Exceptions" class="headerlink" title="Creating the base Exceptions"></a>Creating the base Exceptions</h3><p>With the abstract Exception in place I can now create the base Exceptions.</p>
<p>For example, here is the NotFoundException</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">Cribbb</span>\<span class="title">Exceptions</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotFoundException</span> <span class="keyword">extends</span> <span class="title">CribbbException</span>  </span></span><br><span class="line"><span class="class"></span>&#123;  </span><br><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> string  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$status</span> = <span class="string">&#x27;404’;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">/**  </span></span><br><span class="line"><span class="string">* @return void  </span></span><br><span class="line"><span class="string">*/  </span></span><br><span class="line"><span class="string">public function __construct()  </span></span><br><span class="line"><span class="string">&#123;  </span></span><br><span class="line"><span class="string">$message = $this-&gt;build(func_get_args());</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">parent::__construct($message);  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br></pre></td></tr></table></figure>
<p>Each base foundation Exception simply needs to provide the status code and a call to the __construct() method that will call the build() method and pass the message to the parent.</p>
<p>You can now create these simple Exception classes to represent each HTTP status code your application will be using.</p>
<p>If you need to add a new HTTP status code response, it’s very easy to just create a new child class.</p>
<h3 id="Creating-the-application-Exceptions"><a href="#Creating-the-application-Exceptions" class="headerlink" title="Creating the application Exceptions"></a>Creating the application Exceptions</h3><p>Finally we can use these base HTTP Exceptions within our application code to provide more specific Exceptions.</p>
<p>For example you might have a UserNotFound Exception:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">namespace</span> <span class="title">Cribbb</span>\<span class="title">Users</span>\<span class="title">Exceptions</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Cribbb</span>\<span class="title">Exceptions</span>\<span class="title">NotFoundException</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserNotFound</span> <span class="keyword">extends</span> <span class="title">NotFoundException</span>  </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>Now whenever you attempt to find a user, but the user is not found you can throw this Exception.</p>
<p>The Exception will bubble up to the surface and the correct HTTP Response will be automatically returned with an appropriate error message.</p>
<p>This means if an Exception is throw, you can just let it go, you don’t have to catch it because the consumer needs to be informed that the user was not found.</p>
<p>And in your tests you can assert a UserNotFound exception was thrown, rather than just a generic NotFound exception. This means you can write tests where you are confident the test is failing for the correct reason. This makes reading your tests very easy to understand.</p>
<h3 id="Dealing-with-Exceptions-and-returning-the-correct-response"><a href="#Dealing-with-Exceptions-and-returning-the-correct-response" class="headerlink" title="Dealing with Exceptions and returning the correct response"></a>Dealing with Exceptions and returning the correct response</h3><p>Laravel allows you to handle Exceptions and return a response in the Handler.php file under the Exceptions namespace.</p>
<p>The first thing I’m going to do is to add the base CribbbException class to the $dontReport array.</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* A list of the exception types that should not be reported  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@var</span> array  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$dontReport</span> = [  </span><br><span class="line">	HttpException::class,  </span><br><span class="line">	CribbbException::class  </span><br><span class="line">];  </span><br></pre></td></tr></table></figure>

<p>I don’t need to be told that an application specific Exception has been thrown because this is to be expected. By extending from the base CribbbException class we’ve made it very easy to capture all of the application specific exceptions.</p>
<p>Next I’m going to update the render() method to only render the Exception if we’ve got the app.debug config setting to true, otherwise we can deal with the Exception in the handle() method:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Render an exception into an HTTP response  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> Request $request  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> Exception $e  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> Response  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Exception</span> <span class="variable">$e</span></span>)  </span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="keyword">if</span> (config(<span class="string">&#x27;app.debug&#x27;</span>)) &#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">parent</span>::render(<span class="variable">$request</span>, <span class="variable">$e</span>);  </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;handle(<span class="variable">$request</span>, <span class="variable">$e</span>);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>And finally we can convert the Exception into a JsonResponse in the handle() method:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**  </span></span><br><span class="line"><span class="comment">* Convert the Exception into a JSON HTTP Response  </span></span><br><span class="line"><span class="comment">*  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> Request $request  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> Exception $e  </span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> JSONResponse  </span></span><br><span class="line"><span class="comment">*/</span>  </span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">handle</span>(<span class="params"><span class="variable">$request</span>, <span class="built_in">Exception</span> <span class="variable">$e</span></span>) </span>&#123;  </span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$e</span> <span class="keyword">instanceOf</span> CribbbException) &#123;  </span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$e</span>-&gt;toArray();  </span><br><span class="line"><span class="variable">$status</span> = <span class="variable">$e</span>-&gt;getStatus();  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$e</span> <span class="keyword">instanceOf</span> NotFoundHttpException) &#123;  </span><br><span class="line"><span class="variable">$data</span> = array_merge([  </span><br><span class="line"><span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;not_found&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;status&#x27;</span> =&gt; <span class="string">&#x27;404&#x27;</span>  </span><br><span class="line">], config(<span class="string">&#x27;errors.not_found&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$status</span> = <span class="number">404</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$e</span> <span class="keyword">instanceOf</span> MethodNotAllowedHttpException) &#123;  </span><br><span class="line"><span class="variable">$data</span> = array_merge([  </span><br><span class="line"><span class="string">&#x27;id&#x27;</span> =&gt; <span class="string">&#x27;method_not_allowed&#x27;</span>,  </span><br><span class="line"><span class="string">&#x27;status&#x27;</span> =&gt; <span class="string">&#x27;405&#x27;</span>  </span><br><span class="line">], config(<span class="string">&#x27;errors.method_not_allowed&#x27;</span>));</span><br><span class="line"></span><br><span class="line"><span class="variable">$status</span> = <span class="number">405</span>;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> response()-&gt;json(<span class="variable">$data</span>, <span class="variable">$status</span>);  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>For the CribbbException classes we can simply call the toArray() method to return the Exception into an array as well as the getStatus() method to return the HTTP Status Code.</p>
<p>We can also deal with any other Exception classes in this method. As you can see I’m catching the NotFoundHttpException and MethodNotAllowedHttpException Exceptions in this example so I can return the correct response.</p>
<p>Finally we can return a JsonResponse by using the json() method on the response() helper function method with the $data and $status included.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>Exceptions are a very important aspect of application development and they are an excellent tool in controlling the execution flow of the application.</p>
<p>Under exceptional circumstances you need to halt the application and return an error rather than continuing on with execution. Exceptions make this very easy to achieve.</p>
<p>It’s important that an API always returns the correct HTTP status code. The API is the interface to your application and so it is very important that you follow the recognised standards and protocols.</p>
<p>You also need to return a human readable error message as well as provide up-to-date documentation of the problem and how it can be resolved.</p>
<p>In today’s tutorial we’ve created a foundation for using Exceptions in the application by creating base classes for each HTTP status code.</p>
<p>Whenever a problem arrises in the application we have no reason not to return the specific HTTP status code for that problem.</p>
<p>We’ve also put in place an easy way to list detailed error messages for every possible thing that could go wrong.</p>
<p>This will be easy to keep up-to-date because it’s all in one place.</p>
<p>And finally we’ve created an easy way to use Exceptions in the application. By extending these base Exceptions with application specific exceptions we can create a very granular layer of Exceptions within our application code.</p>
<p>This make it very easy to write tests where you can assert that the correct Exception is being thrown under the specific circumstances.</p>
<p>And it also make it really easy to deal with exceptions because 9 times out of 10 you can just let the exception bubble up to the surface.</p>
<p>When the exception reaches the surface, the correct HTTP status code and error message will automatically be returned to the client.</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/04/nginx%E4%BD%BF%E7%94%A8lua-redis%E9%99%90%E5%88%B6ip%E7%9A%84%E8%AE%BF%E9%97%AE%E9%A2%91%E7%8E%87/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/04/nginx%E4%BD%BF%E7%94%A8lua-redis%E9%99%90%E5%88%B6ip%E7%9A%84%E8%AE%BF%E9%97%AE%E9%A2%91%E7%8E%87/" class="post-title-link" itemprop="url">Nginx使用Lua+Redis限制IP的访问频率</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-04 09:23:22 / 修改时间：10:29:37" itemprop="dateCreated datePublished" datetime="2018-06-04T09:23:22+09:00">2018-06-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
不登高山，不知天之高也；不临深溪，不知地之厚也。
</blockquote>

<h3 id="添加访问控制的Lua脚本"><a href="#添加访问控制的Lua脚本" class="headerlink" title="添加访问控制的Lua脚本"></a>添加访问控制的Lua脚本</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@hbase31 ~]<span class="comment"># vim /usr/local/openresty/nginx/conf/lua/access.lua</span></span><br></pre></td></tr></table></figure>

<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> ip_block_time=<span class="number">300</span> <span class="comment">--封禁IP时间（秒）</span></span><br><span class="line"><span class="keyword">local</span> ip_time_out=<span class="number">30</span>    <span class="comment">--指定ip访问频率时间段（秒）</span></span><br><span class="line"><span class="keyword">local</span> ip_max_count=<span class="number">20</span> <span class="comment">--指定ip访问频率计数最大值（秒）</span></span><br><span class="line"><span class="keyword">local</span> BUSINESS = ngx.var.business <span class="comment">--nginx的location中定义的业务标识符</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">--连接redis</span></span><br><span class="line"><span class="keyword">local</span> redis = <span class="built_in">require</span> <span class="string">&quot;resty.redis&quot;</span>  </span><br><span class="line"><span class="keyword">local</span> conn = redis:new()  </span><br><span class="line">ok, err = conn:connect(<span class="string">&quot;192.168.1.30&quot;</span>, <span class="number">6379</span>)  </span><br><span class="line">conn:set_timeout(<span class="number">2000</span>) <span class="comment">--超时时间2秒</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">--如果连接失败，跳转到脚本结尾</span></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">goto</span> FLAG</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">--查询ip是否被禁止访问，如果存在则返回403错误代码</span></span><br><span class="line">is_block, err = conn:get(BUSINESS..<span class="string">&quot;-BLOCK-&quot;</span>..ngx.var.remote_addr)  </span><br><span class="line"><span class="keyword">if</span> is_block == <span class="string">&#x27;1&#x27;</span> <span class="keyword">then</span></span><br><span class="line">    ngx.<span class="built_in">exit</span>(<span class="number">403</span>)</span><br><span class="line">    <span class="keyword">goto</span> FLAG</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">--查询redis中保存的ip的计数器</span></span><br><span class="line">ip_count, err = conn:get(BUSINESS..<span class="string">&quot;-COUNT-&quot;</span>..ngx.var.remote_addr)</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span> ip_count == ngx.null <span class="keyword">then</span> <span class="comment">--如果不存在，则将该IP存入redis，并将计数器设置为1、该KEY的超时时间为ip_time_out</span></span><br><span class="line">    res, err = conn:set(BUSINESS..<span class="string">&quot;-COUNT-&quot;</span>..ngx.var.remote_addr, <span class="number">1</span>)</span><br><span class="line">    res, err = conn:expire(BUSINESS..<span class="string">&quot;-COUNT-&quot;</span>..ngx.var.remote_addr, ip_time_out)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    ip_count = ip_count + <span class="number">1</span> <span class="comment">--存在则将单位时间内的访问次数加1</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> ip_count &gt;= ip_max_count <span class="keyword">then</span> <span class="comment">--如果超过单位时间限制的访问次数，则添加限制访问标识，限制时间为ip_block_time</span></span><br><span class="line">        res, err = conn:set(BUSINESS..<span class="string">&quot;-BLOCK-&quot;</span>..ngx.var.remote_addr, <span class="number">1</span>)</span><br><span class="line">        res, err = conn:expire(BUSINESS..<span class="string">&quot;-BLOCK-&quot;</span>..ngx.var.remote_addr, ip_block_time)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        res, err = conn:set(BUSINESS..<span class="string">&quot;-COUNT-&quot;</span>..ngx.var.remote_addr,ip_count)</span><br><span class="line">        res, err = conn:expire(BUSINESS..<span class="string">&quot;-COUNT-&quot;</span>..ngx.var.remote_addr, ip_time_out)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">-- 结束标记</span></span><br><span class="line">::FLAG::</span><br><span class="line"><span class="keyword">local</span> ok, err = conn:<span class="built_in">close</span>()</span><br></pre></td></tr></table></figure>
<p>这个脚本的目的很简单：一个IP如果在30秒内其访问次数达到20次则表明该IP访问频率太快了，因此将该IP封禁5分钟。同时由于计数的KEY在Redis中的超时时间设置成了30秒，所以如果两次访问间隔时间大于30秒将会重新开始计数</p>
<h3 id="在Nginx需要限速的location中引用上述脚本"><a href="#在Nginx需要限速的location中引用上述脚本" class="headerlink" title="在Nginx需要限速的location中引用上述脚本"></a>在Nginx需要限速的location中引用上述脚本</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location /user/ &#123;</span><br><span class="line">    set <span class="variable">$business</span> <span class="string">&quot;USER&quot;</span>;</span><br><span class="line">    access_by_lua_file /usr/local/openresty/nginx/conf/lua/access.lua;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header        X-<span class="keyword">Real</span>-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header        X-Forwarded-<span class="keyword">For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_pass http:<span class="comment">//user_224/user/;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>注：对于有大量静态资源文件（如：js、css、图片等）的前端页面可以设置只有指定格式的请求才进行访问限速，示例代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">location /h5 &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$request_uri</span> ~ .*\.(html|htm|jsp|json)) &#123;</span><br><span class="line">            set <span class="variable">$business</span> <span class="string">&quot;H5&quot;</span>;</span><br><span class="line">            access_by_lua_file /usr/local/openresty/nginx/conf/lua/access.lua;</span><br><span class="line">        &#125;</span><br><span class="line">        proxy_redirect off;</span><br><span class="line">        proxy_set_header        Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header        X-<span class="keyword">Real</span>-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        proxy_set_header        X-Forwarded-<span class="keyword">For</span> <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">        proxy_pass http:<span class="comment">//h5_224/h5;</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><a target="_blank" rel="noopener" href="https://juejin.im/entry/5a45a9b8f265da431f4b62d5">https://juejin.im/entry/5a45a9b8f265da431f4b62d5</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/02/laravel%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/02/laravel%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/" class="post-title-link" itemprop="url">laravel最佳实践</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-02 14:42:00 / 修改时间：15:57:20" itemprop="dateCreated datePublished" datetime="2018-06-02T14:42:00+09:00">2018-06-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
着意闻时不肯香，香在无心处。
</blockquote>

<h3 id="Single-responsibility-principle"><a href="#Single-responsibility-principle" class="headerlink" title="Single responsibility principle"></a>Single responsibility principle</h3><p>A class and a method should have only one responsibility.</p>
<p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFullNameAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (auth()-&gt;user() &amp;&amp; auth()-&gt;user()-&gt;hasRole(<span class="string">&#x27;client&#x27;</span>) &amp;&amp; auth()-&gt;user()-&gt;isVerified()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;Mr. &#x27;</span> . <span class="keyword">$this</span>-&gt;first_name . <span class="string">&#x27; &#x27;</span> . <span class="keyword">$this</span>-&gt;middle_name . <span class="string">&#x27; &#x27;</span> <span class="keyword">$this</span>-&gt;last_name;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;first_name[<span class="number">0</span>] . <span class="string">&#x27;. &#x27;</span> . <span class="keyword">$this</span>-&gt;last_name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFullNameAttribute</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;isVerifiedClient() ? <span class="keyword">$this</span>-&gt;getFullNameLong() : <span class="keyword">$this</span>-&gt;getFullNameShort();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isVerfiedClient</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> auth()-&gt;user() &amp;&amp; auth()-&gt;user()-&gt;hasRole(<span class="string">&#x27;client&#x27;</span>) &amp;&amp; auth()-&gt;user()-&gt;isVerified();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFullNameLong</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;Mr. &#x27;</span> . <span class="keyword">$this</span>-&gt;first_name . <span class="string">&#x27; &#x27;</span> . <span class="keyword">$this</span>-&gt;middle_name . <span class="string">&#x27; &#x27;</span> . <span class="keyword">$this</span>-&gt;last_name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getFullNameShort</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;first_name[<span class="number">0</span>] . <span class="string">&#x27;. &#x27;</span> . <span class="keyword">$this</span>-&gt;last_name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Fat-models-skinny-controllers"><a href="#Fat-models-skinny-controllers" class="headerlink" title="Fat models, skinny controllers"></a>Fat models, skinny controllers</h3><p>Put all DB related logic into Eloquent models or into Repository classes if you’re using Query Builder or raw SQL queries.</p>
<p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$clients</span> = Client::verified()</span><br><span class="line">        -&gt;with([<span class="string">&#x27;orders&#x27;</span> =&gt; <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$q</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$q</span>-&gt;where(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, Carbon::today()-&gt;subWeek());</span><br><span class="line">        &#125;])</span><br><span class="line">        -&gt;get();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">&#x27;index&#x27;</span>, [<span class="string">&#x27;clients&#x27;</span> =&gt; <span class="variable">$clients</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> view(<span class="string">&#x27;index&#x27;</span>, [<span class="string">&#x27;clients&#x27;</span> =&gt; <span class="keyword">$this</span>-&gt;client-&gt;getWithNewOrders()]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">Client</span> <span class="keyword">extends</span> <span class="title">Model</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWithNewOrders</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;verified()</span><br><span class="line">            -&gt;with([<span class="string">&#x27;orders&#x27;</span> =&gt; <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$q</span></span>) </span>&#123;</span><br><span class="line">                <span class="variable">$q</span>-&gt;where(<span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;&gt;&#x27;</span>, Carbon::today()-&gt;subWeek());</span><br><span class="line">            &#125;])</span><br><span class="line">            -&gt;get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Validation"><a href="#Validation" class="headerlink" title="Validation"></a>Validation</h3><p>Move validation from controllers to Request classes.</p>
<p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$request</span>-&gt;validate([</span><br><span class="line">        <span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;required|unique:posts|max:255&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;body&#x27;</span> =&gt; <span class="string">&#x27;required&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;publish_at&#x27;</span> =&gt; <span class="string">&#x27;nullable|date&#x27;</span>,</span><br><span class="line">    ]);</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">PostRequest <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;    </span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostRequest</span> <span class="keyword">extends</span> <span class="title">Request</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rules</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [</span><br><span class="line">            <span class="string">&#x27;title&#x27;</span> =&gt; <span class="string">&#x27;required|unique:posts|max:255&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;body&#x27;</span> =&gt; <span class="string">&#x27;required&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;publish_at&#x27;</span> =&gt; <span class="string">&#x27;nullable|date&#x27;</span>,</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Business-logic-should-be-in-service-class"><a href="#Business-logic-should-be-in-service-class" class="headerlink" title="Business logic should be in service class"></a>Business logic should be in service class</h3><p>A controller must have only one responsibility, so move business logic from controllers to service classes.</p>
<p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$request</span>-&gt;hasFile(<span class="string">&#x27;image&#x27;</span>)) &#123;</span><br><span class="line">        <span class="variable">$request</span>-&gt;file(<span class="string">&#x27;image&#x27;</span>)-&gt;move(public_path(<span class="string">&#x27;images&#x27;</span>) . <span class="string">&#x27;temp&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">store</span>(<span class="params">Request <span class="variable">$request</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;articleService-&gt;handleUploadedImage(<span class="variable">$request</span>-&gt;file(<span class="string">&#x27;image&#x27;</span>));</span><br><span class="line"></span><br><span class="line">    ....</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleService</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">handleUploadedImage</span>(<span class="params"><span class="variable">$image</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!is_null(<span class="variable">$image</span>)) &#123;</span><br><span class="line">            <span class="variable">$image</span>-&gt;move(public_path(<span class="string">&#x27;images&#x27;</span>) . <span class="string">&#x27;temp&#x27;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Don’t-repeat-yourself-DRY"><a href="#Don’t-repeat-yourself-DRY" class="headerlink" title="Don’t repeat yourself (DRY)"></a>Don’t repeat yourself (DRY)</h3><p>Reuse code when you can. SRP is helping you to avoid duplication. Also, reuse Blade templates, use Eloquent scopes etc.</p>
<p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getActive</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;where(<span class="string">&#x27;verified&#x27;</span>, <span class="number">1</span>)-&gt;whereNotNull(<span class="string">&#x27;deleted_at&#x27;</span>)-&gt;get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getArticles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereHas(<span class="string">&#x27;user&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$q</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$q</span>-&gt;where(<span class="string">&#x27;verified&#x27;</span>, <span class="number">1</span>)-&gt;whereNotNull(<span class="string">&#x27;deleted_at&#x27;</span>);</span><br><span class="line">        &#125;)-&gt;get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">scopeActive</span>(<span class="params"><span class="variable">$q</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$q</span>-&gt;where(<span class="string">&#x27;verified&#x27;</span>, <span class="number">1</span>)-&gt;whereNotNull(<span class="string">&#x27;deleted_at&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getActive</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;active()-&gt;get();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getArticles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;whereHas(<span class="string">&#x27;user&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params"><span class="variable">$q</span></span>) </span>&#123;</span><br><span class="line">            <span class="variable">$q</span>-&gt;active();</span><br><span class="line">        &#125;)-&gt;get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Prefer-to-use-Eloquent-over-using-Query-Builder-and-raw-SQL-queries-Prefer-collections-over-arrays"><a href="#Prefer-to-use-Eloquent-over-using-Query-Builder-and-raw-SQL-queries-Prefer-collections-over-arrays" class="headerlink" title="Prefer to use Eloquent over using Query Builder and raw SQL queries. Prefer collections over arrays"></a>Prefer to use Eloquent over using Query Builder and raw SQL queries. Prefer collections over arrays</h3><p>Eloquent allows you to write readable and maintainable code. Also, Eloquent has great built-in tools like soft deletes, events, scopes etc.</p>
<p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line"><span class="keyword">FROM</span> `articles`</span><br><span class="line">WHERE EXISTS (SELECT *</span><br><span class="line">              <span class="keyword">FROM</span> `users`</span><br><span class="line">              WHERE `articles`.`user_id` = `users`.`id`</span><br><span class="line">              <span class="keyword">AND</span> EXISTS (SELECT *</span><br><span class="line">                          <span class="keyword">FROM</span> `profiles`</span><br><span class="line">                          WHERE `profiles`.`user_id` = `users`.`id`) </span><br><span class="line">              <span class="keyword">AND</span> `users`.`deleted_at` IS <span class="literal">NULL</span>)</span><br><span class="line"><span class="keyword">AND</span> `verified` = <span class="string">&#x27;1&#x27;</span></span><br><span class="line"><span class="keyword">AND</span> `active` = <span class="string">&#x27;1&#x27;</span></span><br><span class="line">ORDER BY `created_at` DESC</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Article::has(<span class="string">&#x27;user.profile&#x27;</span>)-&gt;verified()-&gt;latest()-&gt;get();</span><br></pre></td></tr></table></figure>

<h3 id="Mass-assignment"><a href="#Mass-assignment" class="headerlink" title="Mass assignment"></a>Mass assignment</h3><p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$article</span> = <span class="keyword">new</span> Article;</span><br><span class="line"><span class="variable">$article</span>-&gt;title = <span class="variable">$request</span>-&gt;title;</span><br><span class="line"><span class="variable">$article</span>-&gt;content = <span class="variable">$request</span>-&gt;content;</span><br><span class="line"><span class="variable">$article</span>-&gt;verified = <span class="variable">$request</span>-&gt;verified;</span><br><span class="line"><span class="comment">// Add category to article</span></span><br><span class="line"><span class="variable">$article</span>-&gt;category_id = <span class="variable">$category</span>-&gt;id;</span><br><span class="line"><span class="variable">$article</span>-&gt;save();</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$category</span>-&gt;article()-&gt;create(<span class="variable">$request</span>-&gt;all());</span><br></pre></td></tr></table></figure>

<h3 id="Do-not-execute-queries-in-Blade-templates-and-use-eager-loading-N-1-problem"><a href="#Do-not-execute-queries-in-Blade-templates-and-use-eager-loading-N-1-problem" class="headerlink" title="Do not execute queries in Blade templates and use eager loading (N + 1 problem)"></a>Do not execute queries in Blade templates and use eager loading (N + 1 problem)</h3><p>Bad (for 100 users, 101 DB queries will be executed):</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">foreach</span> (User::all() <span class="keyword">as</span> <span class="variable">$user</span>)</span><br><span class="line">    &#123;&#123; <span class="variable">$user</span>-&gt;profile-&gt;name &#125;&#125;</span><br><span class="line">@<span class="keyword">endforeach</span></span><br></pre></td></tr></table></figure>
<p>Good (for 100 users, 2 DB queries will be executed):</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$users</span> = User::with(<span class="string">&#x27;profile&#x27;</span>)-&gt;get();</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">@<span class="keyword">foreach</span> (<span class="variable">$users</span> <span class="keyword">as</span> <span class="variable">$user</span>)</span><br><span class="line">    &#123;&#123; <span class="variable">$user</span>-&gt;profile-&gt;name &#125;&#125;</span><br><span class="line">@<span class="keyword">endforeach</span></span><br></pre></td></tr></table></figure>

<h3 id="Comment-your-code-but-prefer-descriptive-method-and-variable-names-over-comments"><a href="#Comment-your-code-but-prefer-descriptive-method-and-variable-names-over-comments" class="headerlink" title="Comment your code, but prefer descriptive method and variable names over comments"></a>Comment your code, but prefer descriptive method and variable names over comments</h3><p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (count((<span class="keyword">array</span>) <span class="variable">$builder</span>-&gt;getQuery()-&gt;joins) &gt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>Better:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Determine if there are any joins.</span></span><br><span class="line"><span class="keyword">if</span> (count((<span class="keyword">array</span>) <span class="variable">$builder</span>-&gt;getQuery()-&gt;joins) &gt; <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;hasJoins())</span><br></pre></td></tr></table></figure>

<h3 id="Do-not-put-JS-and-CSS-in-Blade-templates-and-do-not-put-any-HTML-in-PHP-classes"><a href="#Do-not-put-JS-and-CSS-in-Blade-templates-and-do-not-put-any-HTML-in-PHP-classes" class="headerlink" title="Do not put JS and CSS in Blade templates and do not put any HTML in PHP classes"></a>Do not put JS and CSS in Blade templates and do not put any HTML in PHP classes</h3><p>Bad:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> article = <span class="string">`&#123;&#123; json_encode($article) &#125;&#125;`</span>;</span><br></pre></td></tr></table></figure>
<p>Better:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;article&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; json_encode($article) &#125;&#125;&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Or</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">class</span>=<span class="string">&quot;js-fav-article&quot;</span> <span class="attr">data-article</span>=<span class="string">&quot;&#123;&#123; json_encode($article) &#125;&#125;&quot;</span>&gt;</span>&#123;&#123; $article-&gt;name &#125;&#125;<span class="tag">&lt;<span class="name">button</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>In a Javascript file:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> article = $(<span class="string">&#x27;#article&#x27;</span>).val();</span><br><span class="line">The best way is to use specialized PHP to JS package to transfer the data.</span><br></pre></td></tr></table></figure>

<h3 id="Use-config-and-language-files-constants-instead-of-text-in-the-code"><a href="#Use-config-and-language-files-constants-instead-of-text-in-the-code" class="headerlink" title="Use config and language files, constants instead of text in the code"></a>Use config and language files, constants instead of text in the code</h3><p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isNormal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$article</span>-&gt;type === <span class="string">&#x27;normal&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> back()-&gt;with(<span class="string">&#x27;message&#x27;</span>, <span class="string">&#x27;Your article has been added!&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">isNormal</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$article</span>-&gt;type === Article::TYPE_NORMAL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> back()-&gt;with(<span class="string">&#x27;message&#x27;</span>, __(<span class="string">&#x27;app.article_added&#x27;</span>));</span><br></pre></td></tr></table></figure>

<h3 id="Use-shorter-and-more-readable-syntax-where-possible"><a href="#Use-shorter-and-more-readable-syntax-where-possible" class="headerlink" title="Use shorter and more readable syntax where possible"></a>Use shorter and more readable syntax where possible</h3><p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$request</span>-&gt;session()-&gt;get(<span class="string">&#x27;cart&#x27;</span>);</span><br><span class="line"><span class="variable">$request</span>-&gt;input(<span class="string">&#x27;name&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session(<span class="string">&#x27;cart&#x27;</span>);</span><br><span class="line"><span class="variable">$request</span>-&gt;name;</span><br></pre></td></tr></table></figure>

<h3 id="Use-IoC-container-or-facades-instead-of-new-Class"><a href="#Use-IoC-container-or-facades-instead-of-new-Class" class="headerlink" title="Use IoC container or facades instead of new Class"></a>Use IoC container or facades instead of new Class</h3><p>new Class syntax creates tight coupling between classes and complicates testing. Use IoC container or facades instead.</p>
<p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$user</span> = <span class="keyword">new</span> User;</span><br><span class="line"><span class="variable">$user</span>-&gt;create(<span class="variable">$request</span>-&gt;all());</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params">User <span class="variable">$user</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;user = <span class="variable">$user</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">$this</span>-&gt;user-&gt;create(<span class="variable">$request</span>-&gt;all());</span><br></pre></td></tr></table></figure>

<h3 id="Do-not-get-data-from-the-env-file-directly"><a href="#Do-not-get-data-from-the-env-file-directly" class="headerlink" title="Do not get data from the .env file directly"></a>Do not get data from the .env file directly</h3><p>Pass the data to config files instead and then use the config() helper function to use the data in an application.</p>
<p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$apiKey</span> = env(<span class="string">&#x27;API_KEY&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/api.php</span></span><br><span class="line"><span class="string">&#x27;key&#x27;</span> =&gt; env(<span class="string">&#x27;API_KEY&#x27;</span>),</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the data</span></span><br><span class="line"><span class="variable">$apiKey</span> = config(<span class="string">&#x27;api.key&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="Store-dates-in-the-standard-format-Use-accessors-and-mutators-to-modify-date-format"><a href="#Store-dates-in-the-standard-format-Use-accessors-and-mutators-to-modify-date-format" class="headerlink" title="Store dates in the standard format. Use accessors and mutators to modify date format"></a>Store dates in the standard format. Use accessors and mutators to modify date format</h3><p>Bad:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; Carbon::createFromFormat(<span class="string">&#x27;Y-d-m H-i&#x27;</span>, <span class="variable">$object</span>-&gt;ordered_at)-&gt;toDateString() &#125;&#125;</span><br><span class="line">&#123;&#123; Carbon::createFromFormat(<span class="string">&#x27;Y-d-m H-i&#x27;</span>, <span class="variable">$object</span>-&gt;ordered_at)-&gt;format(<span class="string">&#x27;m-d&#x27;</span>) &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>Good:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Model</span></span><br><span class="line"><span class="keyword">protected</span> <span class="variable">$dates</span> = [<span class="string">&#x27;ordered_at&#x27;</span>, <span class="string">&#x27;created_at&#x27;</span>, <span class="string">&#x27;updated_at&#x27;</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getMonthDayAttribute</span>(<span class="params"><span class="variable">$date</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$date</span>-&gt;format(<span class="string">&#x27;m-d&#x27;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// View</span></span><br><span class="line">&#123;&#123; <span class="variable">$object</span>-&gt;ordered_at-&gt;toDateString() &#125;&#125;</span><br><span class="line">&#123;&#123; <span class="variable">$object</span>-&gt;ordered_at-&gt;monthDay &#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Other-good-practices"><a href="#Other-good-practices" class="headerlink" title="Other good practices"></a>Other good practices</h3><p>Never put any logic in routes files.</p>
<p>Minimize usage of vanilla PHP in Blade templates.</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/alexeymezenin/laravel-best-practices">https://github.com/alexeymezenin/laravel-best-practices</a><br><a target="_blank" rel="noopener" href="https://laravel-china.org/articles/12762/eighteen-best-practices-of-laravel">https://laravel-china.org/articles/12762/eighteen-best-practices-of-laravel</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/02/laravel%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/02/laravel%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE/" class="post-title-link" itemprop="url">Laravel中使用多个数据库操作数据</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-02 12:50:34 / 修改时间：13:56:34" itemprop="dateCreated datePublished" datetime="2018-06-02T12:50:34+09:00">2018-06-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
人人尽说江南好，游人只合江南老。春水碧于天，画船听雨眠。
垆边人似月，皓腕凝霜雪。未老莫还乡，还乡须断肠。
</blockquote>

<h3 id="定义连接"><a href="#定义连接" class="headerlink" title="定义连接"></a>定义连接</h3><p>在你的数据库配置文件<code>app/config/ database.php</code>你可以定义任何类型的多个数据库连接。事实上，你可以定义尽可能多的连接，只要你愿意。例如，如果你的应用程序有2个 MySQL数据库中提取数据，则可以分别定义他们两个。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">return</span> <span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;default&#x27;</span> =&gt; <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;connections&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 主数据库连接</span></span><br><span class="line">        <span class="string">&#x27;mysql&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span>    =&gt; <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;host&#x27;</span>      =&gt; <span class="string">&#x27;host1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;database&#x27;</span>  =&gt; <span class="string">&#x27;database1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>  =&gt; <span class="string">&#x27;user1&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>  =&gt; <span class="string">&#x27;pass1&#x27;</span></span><br><span class="line">            <span class="string">&#x27;charset&#x27;</span>   =&gt; <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;collation&#x27;</span> =&gt; <span class="string">&#x27;utf8_unicode_ci&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;prefix&#x27;</span>    =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        ),</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 次数据连接</span></span><br><span class="line">        <span class="string">&#x27;mysql2&#x27;</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">&#x27;driver&#x27;</span>    =&gt; <span class="string">&#x27;mysql&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;host&#x27;</span>      =&gt; <span class="string">&#x27;host2&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;database&#x27;</span>  =&gt; <span class="string">&#x27;database2&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;username&#x27;</span>  =&gt; <span class="string">&#x27;user2&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;password&#x27;</span>  =&gt; <span class="string">&#x27;pass2&#x27;</span></span><br><span class="line">            <span class="string">&#x27;charset&#x27;</span>   =&gt; <span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;collation&#x27;</span> =&gt; <span class="string">&#x27;utf8_unicode_ci&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;prefix&#x27;</span>    =&gt; <span class="string">&#x27;&#x27;</span>,</span><br><span class="line">        ),</span><br><span class="line">    ),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>我们默认的连接(default)仍设置为 mysql,这意味着，除非我们特别指定，应用程序将继续使用 mysql 连接.</p>
<h3 id="Schema"><a href="#Schema" class="headerlink" title="Schema"></a>Schema</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Schema::connection(<span class="string">&#x27;mysql2&#x27;</span>)-&gt;create(<span class="string">&#x27;lp_table&#x27;</span>, <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$table</span></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable">$table</span>-&gt;increments(<span class="string">&#x27;id&#x27;</span>):</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h3 id="DB类"><a href="#DB类" class="headerlink" title="DB类"></a>DB类</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DB::connection(<span class="string">&#x27;mysql2&#x27;</span>)-&gt;table(<span class="string">&#x27;article&#x27;</span>)-&gt;where...</span><br></pre></td></tr></table></figure>

<h3 id="Eloquent"><a href="#Eloquent" class="headerlink" title="Eloquent"></a>Eloquent</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeModel</span> <span class="keyword">extends</span> <span class="title">Eloquent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$connection</span> = <span class="string">&#x27;mysql2&#x27;</span>;</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeController</span> <span class="keyword">extends</span> <span class="title">BaseController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">someMethod</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$someModel</span> = <span class="keyword">new</span> SomeModel;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$someModel</span>-&gt;setConnection(<span class="string">&#x27;mysql2&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$something</span> = <span class="variable">$someModel</span>-&gt;find(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$something</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.itlipeng.cn/2015/12/24/%E5%9C%A8-laravel-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE/">https://www.itlipeng.cn/2015/12/24/%E5%9C%A8-laravel-%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%A4%9A%E4%B8%AA%E6%95%B0%E6%8D%AE%E5%BA%93%E6%93%8D%E4%BD%9C%E6%95%B0%E6%8D%AE/</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/02/browser-sync%E6%96%87%E4%BB%B6%E7%9B%91%E5%90%AC%E5%A4%B1%E8%B4%A5%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/02/browser-sync%E6%96%87%E4%BB%B6%E7%9B%91%E5%90%AC%E5%A4%B1%E8%B4%A5%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">browser-sync文件监听失败的解决方案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-02 09:44:04 / 修改时间：10:50:17" itemprop="dateCreated datePublished" datetime="2018-06-02T09:44:04+09:00">2018-06-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
两岸青山相对出，孤帆一片日边来
</blockquote>

<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>为了方便实时预览前端开发过程中修改源码后的页面，推荐一个非常实用的工具，browser-sync。</p>
<p>安装使用方式请自行到官网<a target="_blank" rel="noopener" href="https://browsersync.io/%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3%EF%BC%8C%E4%BB%93%E5%BA%93%E5%9C%B0%E5%9D%80%E5%9C%A8%E8%BF%99%E9%87%8Chttps://github.com/BrowserSync/browser-sync">https://browsersync.io/参考文档，仓库地址在这里https://github.com/BrowserSync/browser-sync</a></p>
<p>GetStart中官网给出的CLI示例命令为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser-sync start --server --files <span class="string">&quot;css/*.css&quot;</span></span><br></pre></td></tr></table></figure>
<p>我将其写到到npm命令中，package.json 相关内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dev&quot;</span>: <span class="string">&quot;browser-sync start --server --files &#x27;css/*.css&#x27;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;browser-sync&quot;</span>: <span class="string">&quot;^2.18.13&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着执行 <code>npm run dev</code>，控制台输出一切正常。</p>
<p>然而，当我修改 <code>css/style.css</code> 这个文件的时候，发现浏览器并没有刷新，这说明 <code>browser-sync</code> 并未成功监听 <code>css/*.css</code> 文件的修改。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>为此，我翻了一遍 <code>browser-sync</code> 的<code>issue</code>，发现有人遇到相同的问题，也给出了解决方案。</p>
<p>问题出在命令行参数上，仔细对比，我们也会发现：</p>
<p>我写的CLI命令为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser-sync start --server --files <span class="string">&#x27;css/*.css&#x27;</span></span><br></pre></td></tr></table></figure>
<p>而官方CLI命令为</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">browser-sync start --server --files <span class="string">&quot;css/*.css&quot;</span></span><br></pre></td></tr></table></figure>
<p>问题就出在分号的不同上（browser-sync没能解析单引号的内容）</p>
<p>解决<br>因此，我将 npm命令 中的 ‘ 替换为 &quot; 即可解决问题。更改后的 package.json 内容如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;dev&quot;</span>: <span class="string">&quot;browser-sync start --server --files \&quot;css/*.css\&quot;&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;devDependencies&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;browser-sync&quot;</span>: <span class="string">&quot;^2.18.13&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/pwc1996/article/details/76849876">https://blog.csdn.net/pwc1996/article/details/76849876</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/06/01/lavavel%E6%8B%92%E7%BB%9D%E8%BD%AF%E5%88%A0%E9%99%A4%E7%9A%84%E7%94%A8%E6%88%B7%E9%82%AE%E7%AE%B1%E5%86%8D%E6%AC%A1%E9%AA%8C%E8%AF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/06/01/lavavel%E6%8B%92%E7%BB%9D%E8%BD%AF%E5%88%A0%E9%99%A4%E7%9A%84%E7%94%A8%E6%88%B7%E9%82%AE%E7%AE%B1%E5%86%8D%E6%AC%A1%E9%AA%8C%E8%AF%81/" class="post-title-link" itemprop="url">Lavavel拒绝软删除的用户邮箱再次验证</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-06-01 14:06:43 / 修改时间：15:14:06" itemprop="dateCreated datePublished" datetime="2018-06-01T14:06:43+09:00">2018-06-01</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
松下问童子，言师采药去。只在此山中，云深不知处。
</blockquote>

<p>When creating user authorization system with soft-deletable data we might encounter a problem: deleted user might try to register with same email address and gets an error that it is in use. What to do in order to prevent it? Here is a quite simple example of how it could be solved.</p>
<p>First of all – by default Laravel migrations for users table have a unique index on email field. This needs to be modified – we need to have unique values on email and deleted_at fields at the same time. So let’s write our migration like this:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">up</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Schema::create(<span class="string">&#x27;users&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">Blueprint <span class="variable">$table</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$table</span>-&gt;increments(<span class="string">&#x27;id&#x27;</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">&#x27;name&#x27;</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">&#x27;email&#x27;</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;string(<span class="string">&#x27;password&#x27;</span>);</span><br><span class="line">        <span class="variable">$table</span>-&gt;rememberToken();</span><br><span class="line">        <span class="variable">$table</span>-&gt;timestamps();</span><br><span class="line">        <span class="variable">$table</span>-&gt;softDeletes();</span><br><span class="line"></span><br><span class="line">        <span class="variable">$table</span>-&gt;unique([<span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;deleted_at&#x27;</span>]);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As you can see, we have a unique index for email and deleted_at at the same time. It is called a composite index. From now on – it is impossible to have two entries that would have identical information in both fields as long as none of them are NULL (except for a situation where your deleted_at field is set to NULL. This is not a bug due the fact that unique allows multiple NULL values in a column: <a target="_blank" rel="noopener" href="http://dev.mysql.com/doc/refman/5.7/en/create-index.html">http://dev.mysql.com/doc/refman/5.7/en/create-index.html</a> – see comment below)</p>
<blockquote>
<p>A UNIQUE index creates a constraint such that all values in the index must be distinct. An error occurs if you try to add a new row with a key value that matches an existing row. For all engines, a UNIQUE index permits multiple NULL values for columns that can contain NULL. If you specify a prefix value for a column in a UNIQUE index, the column values must be unique within the prefix.</p>
</blockquote>
<p>Now, to match a case where our user might not be deleted yet and we don’t want him to register with same email again – we need to change email validation rule:</p>
<p>Open our app/Http/Controllers/Auth/AuthController.php file (Request or other Controller where you have the validation rule) and change your email validation to this:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;email&#x27;</span> =&gt; <span class="string">&#x27;required|email|max:255|unique:users,email,NULL,id,deleted_at,NULL&#x27;</span>,</span><br></pre></td></tr></table></figure>

<p>You might need to modify table name, column name and etc. for your needs.</p>
<p>And that’s it. Your user is able to register again with the same email as he did before and Laravel will make sure that the email is not within active users. Just don’t forget that when restoring it you need to check if there are no active users with identical email. This might not be the best solution for you, so we made a tiny list of other possible solutions. Feel free to choose any other if this doesn’t work for you or suggest us a new one!</p>
<ul>
<li>Make a second table where you would store deleted users email and set a random string in the original database. On restore just copy the email back and delete the dummy row.</li>
<li>On user delete (using an observer or manually) prepend users email with a prefix: _deleted or something like that.</li>
<li>… your suggestions?</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://laraveldaily.com/make-soft-deleted-user-email-available/">http://laraveldaily.com/make-soft-deleted-user-email-available/</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/05/31/laravel%E4%B9%8B%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E5%92%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%8C%BA%E5%88%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/31/laravel%E4%B9%8B%E5%BC%80%E5%8F%91%E6%B5%8B%E8%AF%95%E5%92%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%8C%BA%E5%88%86/" class="post-title-link" itemprop="url">Laravel之开发测试和生产环境区分</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-05-31 11:48:11 / 修改时间：13:05:32" itemprop="dateCreated datePublished" datetime="2018-05-31T11:48:11+09:00">2018-05-31</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
不做动机揣测，少做价值判断
</blockquote>

<p>Laravel环境检测的方法是很容易的，因为大家都知道Laravel中使用了Dotenv来做文件配置，这就牵扯到了我们的都很熟悉的.env。</p>
<p>比如一个典型的.env是:</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">APP_ENV=local</span><br><span class="line">APP_DEBUG=<span class="literal">true</span></span><br><span class="line">APP_KEY=base64:<span class="number">3</span>csTuw5O1me1PF4j9xErbUR+seyH1xdf6uRfvjuQ22Q=</span><br><span class="line">APP_URL=http:<span class="comment">//localhost</span></span><br><span class="line"></span><br><span class="line">DB_CONNECTION=mysql</span><br><span class="line">DB_HOST=<span class="number">127.0</span>.<span class="number">0.1</span></span><br><span class="line">DB_PORT=<span class="number">3306</span></span><br><span class="line">DB_DATABASE=db_name</span><br><span class="line">DB_USERNAME=db_user</span><br><span class="line">DB_PASSWORD=db_pass</span><br><span class="line"><span class="comment">//...省略</span></span><br></pre></td></tr></table></figure>
<p>今天我的这篇分享主要介绍两种区分不同环境的方法。</p>
<h3 id="不同环境维护自己的-env文件"><a href="#不同环境维护自己的-env文件" class="headerlink" title="不同环境维护自己的.env文件"></a>不同环境维护自己的.env文件</h3><p>这种办法也是Laravel默认的办法，也就是开发环境、测试环境和生产环境各自维护自己的.env文件，也就是说.env不要加到版本控制系统中，通过不同的配置可以做到环境的区分，比如:</p>
<p>开发环境</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">APP_ENV=dev</span><br><span class="line"><span class="comment">//...省略</span></span><br></pre></td></tr></table></figure>
<p>测试环境</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">APP_ENV=staging</span><br><span class="line"><span class="comment">//...省略</span></span><br></pre></td></tr></table></figure>
<p>生产环境</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">APP_ENV=production</span><br><span class="line"><span class="comment">//...省略</span></span><br></pre></td></tr></table></figure>
<p>这样，在我们的代码中即可以通过判断APP_ENV来判断是哪种环境。但是这种办法我个人是不太喜欢的，原因有以下几点:</p>
<ul>
<li>环境的判断过多的写到代码里面，维护起来很麻烦</li>
<li>如果某次上线需要修改配置文件，则每次上线代码还需要到线上机器修改.env文件，部署起来很麻烦</li>
</ul>
<h3 id="不同环境加载自己的-env-文件"><a href="#不同环境加载自己的-env-文件" class="headerlink" title="不同环境加载自己的.env.文件"></a>不同环境加载自己的.env.文件</h3><p>这里面的.env.文件延伸开来就是.env.dev、.env.test和.env.prod，比如开发环境会自动加载.env.dev，依此类推，那么如果是这样的话，不同环境的机器又怎么知道加载哪个文件呢？其实这里面还是耍了点小聪明，别忘了我们有php.ini</p>
<ul>
<li>1.在php.ini中追加一行配置<br>当然开发、测试和生产环境中env所对应的值也需要不一样<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开发环境</span></span><br><span class="line">env=dev</span><br><span class="line"><span class="comment">//测试环境</span></span><br><span class="line">env=staging</span><br><span class="line"><span class="comment">//生产环境</span></span><br><span class="line">env=production</span><br></pre></td></tr></table></figure></li>
<li>2.加载不同的配置文件<br>在bootstrap/app.php文件中添加如下判断，在这里将通过获取php.ini中的env的值，然后从而加载不同的配置文件。<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//...省略</span></span><br><span class="line"><span class="variable">$env</span> = get_cfg_var(<span class="string">&#x27;env&#x27;</span>);</span><br><span class="line"><span class="variable">$env</span> = !<span class="keyword">empty</span>(<span class="variable">$env</span>) ? <span class="variable">$env</span> : <span class="string">&#x27;production&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span>(!defined(<span class="string">&#x27;APP_MODE&#x27;</span>))&#123;</span><br><span class="line">    define(<span class="string">&#x27;APP_MODE&#x27;</span>, <span class="variable">$env</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$app</span>-&gt;loadEnvironmentFrom(<span class="string">&#x27;.env.&#x27;</span>.<span class="variable">$env</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="variable">$app</span>;</span><br></pre></td></tr></table></figure></li>
<li>3.新建.env.dev、.env.staging和.env.production</li>
</ul>
<p>好，就到此为止了，当然虽然我非常喜欢第二种办法，但第二种毕竟需要对线上机器做一次大的改动，需要运维同学支持下。但是也需要具体情况具体来选择吧。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://xuwenzhi.com/2016/07/31/laravel%E4%B9%8B%E5%BC%80%E5%8F%91%E3%80%81%E6%B5%8B%E8%AF%95%E5%92%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%8C%BA%E5%88%86/">http://xuwenzhi.com/2016/07/31/laravel%E4%B9%8B%E5%BC%80%E5%8F%91%E3%80%81%E6%B5%8B%E8%AF%95%E5%92%8C%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E5%8C%BA%E5%88%86/</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://swoole.app/2018/05/30/%E7%8E%B0%E4%BB%A3%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E8%80%85%E5%BF%85%E5%A4%87%E6%8A%80%E8%83%BD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="lnmput@gmail.com">
      <meta itemprop="description" content="要么庸俗，要么孤独">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="杨子鳄鱼 ● 外贸自建站">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2018/05/30/%E7%8E%B0%E4%BB%A3%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91%E8%80%85%E5%BF%85%E5%A4%87%E6%8A%80%E8%83%BD/" class="post-title-link" itemprop="url">现代后端开发者必备技能</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2018-05-30 16:47:52 / 修改时间：17:53:45" itemprop="dateCreated datePublished" datetime="2018-05-30T16:47:52+09:00">2018-05-30</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote class="blockquote-center">
能够击败我的不会是孤独，而是试图摆脱孤独。
</blockquote>

<h3 id="第1步-学习一门语言"><a href="#第1步-学习一门语言" class="headerlink" title="第1步 - 学习一门语言"></a>第1步 - 学习一门语言</h3><p>谈到选择语言有很多选择。我已经将它们分成几类，以便你更容易做出决定。对于刚开始进入后端开发的初学者，我建议你选择任何脚本语言，因为它们有很多需求，它可以让你快速起步。如果你有一些前端知识，你可能会发现Node.js更容易，再加上有一个很大的就业市场。</p>
<p>如果你已经在做后端开发并且知道一些脚本语言，我建议你不要选择另一种脚本语言，并从“功能”或“多参数”部分中选择一些。<br>例如，如果你已经在使用PHP或Node.js，请不要使用Python或Ruby，而应尝试使用Erlang或Golang。它肯定会帮助你延伸思维，并开启你的思想到新的视野。</p>
<h3 id="第2步-练习你学到的东西"><a href="#第2步-练习你学到的东西" class="headerlink" title="第2步 - 练习你学到的东西"></a>第2步 - 练习你学到的东西</h3><p>没有比实践更好的学习方式。一旦你选择了你的语言，并且对这些概念有了基本的了解，就可以使用它们。尽你所能制作尽可能多的小应用程序。尽你所能制作尽可能多的小应用程序：</p>
<p>在bash中实现一些你自己使用的命令尝试实现 ls 的功能<br>编写一个命令，为你提供JSON格式的目录结构，例如 jsonify dir-name 给你一个带有 dir-name 内结构的JSON文件<br>编写一个从上面的步骤读取JSON的命令并创建目录结构<br>想想你每天都在做的一些任务，并尝试将其自动化</p>
<h3 id="第3步-学习软件包管理器"><a href="#第3步-学习软件包管理器" class="headerlink" title="第3步 - 学习软件包管理器"></a>第3步 - 学习软件包管理器</h3><p>了解了该语言的基础知识并制作了一些示例应用程序后，请了解如何使用你选择的语言的软件包管理器。软件包管理器可帮助你在应用程序中使用外部库，并分发你的库供其他人使用。</p>
<p>如果你选择了PHP，你将不得不学习 Composer，Node.js 有 NPM 或 Yarn，Python 有 Pip，Ruby 有 RubyGems。无论你选择什么，请继续学习如何使用其包管理器。</p>
<h3 id="第4步-标准和最佳实践"><a href="#第4步-标准和最佳实践" class="headerlink" title="第4步 - 标准和最佳实践"></a>第4步 - 标准和最佳实践</h3><p>每种语言都有自己的标准和做事的最佳实践。研究他们为你挑选的语言。例如 PHP 有 PHP-FIG 和 PSR 。使用 Node.js 有许多不同的社区驱动指南，其他语言也有相同的指导。</p>
<h3 id="第5步-安全"><a href="#第5步-安全" class="headerlink" title="第5步 - 安全"></a>第5步 - 安全</h3><p>请务必阅读有关安全的最佳做法。阅读 OWASP 指南并了解不同的安全问题以及如何以你选择的语言避免它们。</p>
<h3 id="第6步-练习"><a href="#第6步-练习" class="headerlink" title="第6步 - 练习"></a>第6步 - 练习</h3><p>现在你已经掌握了语言，标准和最佳实践的基础知识，安全性以及如何使用软件包管理器。现在开始创建一个包并分发给其他人使用，并确保遵循你迄今为止学到的标准和最佳实践。例如，如果你选择了PHP，那么你将在Packagist上发布它，如果你选择了Node.js，那么你将在Npm注册源中发布它，等等。</p>
<p>一旦你完成了，在Github上搜索一些项目，并在某些项目中打开一些pull请求。对此的一些想法：</p>
<p>重构并实施你学到的最佳实践<br>查看未解决的问题并尝试解决<br>添加任何附加功能</p>
<h3 id="第7步-了解测试"><a href="#第7步-了解测试" class="headerlink" title="第7步 - 了解测试"></a>第7步 - 了解测试</h3><p>测试有几种不同的测试类型。了解这些类型它们的目的是什么。了解如何在应用程序中编写单元测试和集成测试。另外，了解不同的测试术语，如 mocks, stubs 等。</p>
<h3 id="第8步-实践"><a href="#第8步-实践" class="headerlink" title="第8步 - 实践"></a>第8步 - 实践</h3><p>对于练习，继续编写单元测试，以完成目前为止所做的实际任务，特别是你在步骤6中所做的练习。</p>
<p>还要学习和计算你编写的测试的覆盖率。</p>
<h3 id="第9步-了解关系数据库"><a href="#第9步-了解关系数据库" class="headerlink" title="第9步 - 了解关系数据库"></a>第9步 - 了解关系数据库</h3><p>了解如何将数据保存在关系数据库中。在你选择要学习的工具之前，请先了解不同的数据库术语，例如键，索引，规范化等。</p>
<p>这里有几个选项。但是，如果你学习一个，其他的应该相当容易。你想学习的是MySQL，MariaDB（大部分是相同的，是MySQL的分支）和PostgreSQL。选择MySQL开始。</p>
<h3 id="第十步-实践时间"><a href="#第十步-实践时间" class="headerlink" title="第十步 - 实践时间"></a>第十步 - 实践时间</h3><p>现在是时候把你所学到的一切都用到这里去了。</p>
<p>使用你迄今为止学到的所有内容创建一个简单的应用程序。可以选择任何想法​​，也许创建一个简单的博客应用程序，并实现其中的以下功能。</p>
<p>用户帐户 - 注册和登录<br>注册用户可以创建博客文章<br>用户应该能够查看他创建的所有博客文章<br>他们应该能够删除他们的博客文章<br>确保用户只能看到他的个人博客帖子，而不能看到他人<br>编写应用程序的单元/集成测试<br>你应该为查询应用索引。分析查询以确保正在使用索引</p>
<h3 id="第11步-了解一个框架"><a href="#第11步-了解一个框架" class="headerlink" title="第11步 - 了解一个框架"></a>第11步 - 了解一个框架</h3><p>根据你选择的项目和语言，你可能需要也可能不需要框架。每种语言都有几个不同的选项，继续看看你选择的语言有哪些选项可供选择，然后选择相关的一个。</p>
<p>如果你选择了PHP，我会建议你使用 Laravel或Symfony，如果是为框架的话，使用Lumen或Slim。如果你选择Node.js，有几种不同的选择，但突出的是Express.js。</p>
<h3 id="第12步-实践时间"><a href="#第12步-实践时间" class="headerlink" title="第12步 - 实践时间"></a>第12步 - 实践时间</h3><p>为了实现此步骤，请将你在 步骤10 中创建的应用程序转换为使用你选择的框架。还要确保移植包括测试在内的所有内容。</p>
<h3 id="第13步-学习NoSQL数据库"><a href="#第13步-学习NoSQL数据库" class="headerlink" title="第13步 - 学习NoSQL数据库"></a>第13步 - 学习NoSQL数据库</h3><p>首先了解它们是什么，它们与关系数据库有何不同以及为什么它们是需要的。有几种不同的选择，研究一点看看，并比较它们的特点和差异。你可以选择的一些常用选项是Rdeis，MongoDB，Cassandra，RethinkDB和Couchbase。如果你必须选择一个，请使用Redis。</p>
<h3 id="第14步-缓存"><a href="#第14步-缓存" class="headerlink" title="第14步 - 缓存"></a>第14步 - 缓存</h3><p>了解如何在你的应用程序中实施应用程序级缓存。了解如何使用Redis或Memcached并在你在 步骤12 中创建的应用程序中实施缓存。</p>
<h3 id="第15步-创建RESTful-API"><a href="#第15步-创建RESTful-API" class="headerlink" title="第15步 - 创建RESTful API"></a>第15步 - 创建RESTful API</h3><p>了解REST并学习如何制作RESTful API，并确保从 Roy Fielding 的原始文章中阅读关于REST的部分。如果他们说REST仅适用于HTTP API，请确保你能够与其他人对战。</p>
<h3 id="第16步-了解不同的身份验证方法"><a href="#第16步-了解不同的身份验证方法" class="headerlink" title="第16步 - 了解不同的身份验证方法"></a>第16步 - 了解不同的身份验证方法</h3><p>了解不同的身份验证和授权方法。你应该知道他们是什么，他们有什么不同以及什么时候偏好某一个</p>
<p>OAuth - 开放认证<br>基本认证<br>令牌认证<br>JWT - JSON Web令牌<br>OpenID</p>
<h3 id="第17步-消息代理"><a href="#第17步-消息代理" class="headerlink" title="第17步 - 消息代理"></a>第17步 - 消息代理</h3><p>了解消息代理并了解何时以及为何使用它们。有多种选择，但突出的是 RabbitMQ 和 Kafka。现在学习如何使用RabbitMQ，如果你想选择一个。</p>
<h3 id="第18步-搜索引擎"><a href="#第18步-搜索引擎" class="headerlink" title="第18步 - 搜索引擎"></a>第18步 - 搜索引擎</h3><p>随着应用程序的增长，对关系数据库或NoSQL数据库的简单查询不会将其切断，你将不得不求助于搜索引擎。有多种选择，每种选择都有自己的差异。比如 Solr, Sphinx, ElasticSearch，Xapian等。</p>
<h3 id="第19步-了解如何使用Docker"><a href="#第19步-了解如何使用Docker" class="headerlink" title="第19步 - 了解如何使用Docker"></a>第19步 - 了解如何使用Docker</h3><p>无论你是在复制与生产环境相同的环境，还是保持操作系统清洁或加快你的编码，测试或部署，Docker都可以在开发过程中大大方便你的工作。在这一步中，继续学习如何使用Docker。</p>
<h3 id="第20步-关于Web服务器的知识"><a href="#第20步-关于Web服务器的知识" class="headerlink" title="第20步 - 关于Web服务器的知识"></a>第20步 - 关于Web服务器的知识</h3><p>如果你已经走到这么远，你可能不得不在前面的步骤中使用服务器。这一步主要是找出不同Web服务器之间的差异，了解限制和不同的可用配置选项，以及如何最好地利用这些限制编写应用程序。</p>
<h3 id="第21步-了解如何使用Web-Sockets"><a href="#第21步-了解如何使用Web-Sockets" class="headerlink" title="第21步 - 了解如何使用Web Sockets"></a>第21步 - 了解如何使用Web Sockets</h3><p>虽然不是必需的，但在工具带中有这些知识是有益的。学习如何使用 Web sockets 编写实时Web应用程序并使用它创建一些示例应用程序。你可以在上面制作的博客应用程序中使用它来实现博客文章列表中的实时更新。</p>
<h3 id="第22步-学习GraphQL"><a href="#第22步-学习GraphQL" class="headerlink" title="第22步 - 学习GraphQL"></a>第22步 - 学习GraphQL</h3><p>学习如何使用GraphQL制作API。了解它与REST的不同之处，以及它为什么被称为 REST 2.0。</p>
<h3 id="第23步-研究Graph数据库"><a href="#第23步-研究Graph数据库" class="headerlink" title="第23步 - 研究Graph数据库"></a>第23步 - 研究Graph数据库</h3><p>Graph 模型代表了一种处理数据中关系的非常灵活的方式，图数据库为其提供了快速高效的存储，检索和查询。学习如何使用 Neo4j或 OrientDB。</p>
<h3 id="第24步-保持探索"><a href="#第24步-保持探索" class="headerlink" title="第24步 - 保持探索"></a>第24步 - 保持探索</h3><p>一旦你开始学习和练习，你一定会遇到我们在这个路线图中没有涉及的东西。只要保持开放的心态和对新事物的健康渴望。</p>
<p>记住关键是要尽可能多地练习。它在开始时看起来更加可怕，你可能会觉得你并没有抓住任何东西，但这是正常的，随着时间的推移，你会觉得自己越来越好。</p>
<p>好了，就这么多。感谢阅读。</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://phpcasts.org/posts/modern-backend-developer-in-2018">https://phpcasts.org/posts/modern-backend-developer-in-2018</a></p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><span class="space">&hellip;</span><a class="page-number" href="/page/41/">41</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lnmput@gmail.com</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  




  





</body>
</html>
